generator client {
  provider        = "prisma-client-js"
  output          = "./generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector]
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  users             users   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model admin_audit_logs {
  id          String   @id
  adminUserId String
  merchantId  String?
  action      String
  resource    String?
  resourceId  String?
  oldValue    Json?
  newValue    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([action])
  @@index([adminUserId])
  @@index([createdAt])
  @@index([merchantId])
}

model affiliate_feed_run_errors {
  id                  String              @id
  runId               String
  code                String
  message             String
  rowNumber           Int?
  sample              Json?
  createdAt           DateTime            @default(now())
  affiliate_feed_runs affiliate_feed_runs @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model affiliate_feed_runs {
  id                        String                      @id
  feedId                    String
  sourceId                  String
  trigger                   AffiliateFeedRunTrigger     @default(SCHEDULED)
  status                    AffiliateFeedRunStatus      @default(RUNNING)
  startedAt                 DateTime                    @default(now())
  finishedAt                DateTime?
  durationMs                Int?
  downloadBytes             BigInt?
  rowsRead                  Int?
  rowsParsed                Int?
  productsUpserted          Int?
  pricesWritten             Int?
  productsPromoted          Int?
  errorCount                Int?
  productsExpired           Int?
  productsRejected          Int?
  duplicateKeyCount         Int?
  urlHashFallbackCount      Int?
  activeCountBefore         Int?
  seenSuccessCount          Int?
  wouldExpireCount          Int?
  skippedReason             String?
  failureKind               String?
  failureCode               String?
  failureMessage            String?
  isPartial                 Boolean                     @default(false)
  expiryStepFailed          Boolean                     @default(false)
  expiryBlocked             Boolean                     @default(false)
  expiryBlockedReason       String?
  expiryApprovedAt          DateTime?
  expiryApprovedBy          String?
  artifactUrl               String?
  correlationId             String?
  ignoredAt                 DateTime?
  ignoredBy                 String?
  ignoredReason             String?
  affiliate_feed_run_errors affiliate_feed_run_errors[]
  affiliate_feeds           affiliate_feeds             @relation(fields: [feedId], references: [id], onDelete: Cascade)
  prices                    prices[]
  source_product_seen       source_product_seen[]

  @@index([feedId, startedAt])
  @@index([feedId, status, startedAt])
  @@index([feedId, trigger, startedAt])
  @@index([ignoredAt])
}

model affiliate_feeds {
  id                     String                @id
  sourceId               String
  network                AffiliateNetwork
  status                 AffiliateFeedStatus   @default(DRAFT)
  scheduleFrequencyHours Int?
  nextRunAt              DateTime?
  expiryHours            Int                   @default(48)
  consecutiveFailures    Int                   @default(0)
  lastRunAt              DateTime?
  manualRunPending       Boolean               @default(false)
  transport              FeedTransport         @default(SFTP)
  host                   String?
  port                   Int?
  path                   String?
  username               String?
  secretCiphertext       Bytes?
  secretKeyId            String?
  secretVersion          Int                   @default(1)
  format                 FeedFormat            @default(CSV)
  compression            FeedCompression       @default(NONE)
  lastRemoteMtime        DateTime?
  lastRemoteSize         BigInt?
  lastContentHash        String?
  maxFileSizeBytes       BigInt?
  maxRowCount            Int?
  feedLockId             BigInt                @unique @default(autoincrement())
  createdAt              DateTime              @default(now())
  updatedAt              DateTime
  createdBy              String?
  variant                FeedVariant           @default(FULL)
  affiliate_feed_runs    affiliate_feed_runs[]
  sources                sources               @relation(fields: [sourceId], references: [id])

  @@unique([sourceId, variant])
  @@index([nextRunAt])
  @@index([status])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model alerts {
  id               String           @id
  userId           String
  productId        String
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  watchlistItemId  String?
  ruleType         AlertRuleType?
  isEnabled        Boolean          @default(true)
  suppressedAt     DateTime?
  suppressedBy     String?
  suppressedReason String?
  products         products         @relation(fields: [productId], references: [id], onDelete: Cascade)
  users            users            @relation(fields: [userId], references: [id], onDelete: Cascade)
  watchlist_items  watchlist_items? @relation(fields: [watchlistItemId], references: [id], onDelete: Cascade)

  @@unique([userId, productId, ruleType], map: "alerts_userid_productid_ruletype_key")
  @@index([productId])
  @@index([suppressedAt])
  @@index([watchlistItemId])
}

model brand_alias_applications_daily {
  aliasId   String
  date      DateTime @db.Date
  count     Int      @default(0)
  updatedAt DateTime

  @@id([aliasId, date])
  @@index([aliasId])
  @@index([date])
}

model brand_aliases {
  id                   String               @id
  canonicalName        String
  canonicalNorm        String
  normalizationVersion Int                  @default(1)
  aliasName            String
  aliasNorm            String               @unique
  status               BrandAliasStatus     @default(DRAFT)
  sourceType           BrandAliasSourceType
  sourceRef            String?
  evidence             Json?
  notes                String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime
  createdBy            String
  updatedBy            String
  disabledAt           DateTime?
  disabledBy           String?
  disableReason        String?

  @@index([canonicalNorm])
  @@index([createdAt])
  @@index([status])
}

model click_events {
  id              String           @id
  sessionId       String?
  userAgent       String?
  ipHash          String?
  referrer        String?
  createdAt       DateTime         @default(now())
  clickId         String           @unique
  sourceId        String?
  sourceProductId String?
  targetUrl       String?
  retailerId      String
  retailers       retailers        @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  sources         sources?         @relation(fields: [sourceId], references: [id])
  source_products source_products? @relation(fields: [sourceProductId], references: [id])

  @@index([createdAt])
  @@index([retailerId])
  @@index([sessionId])
  @@index([sourceId])
  @@index([sourceProductId])
}

model data_subscriptions {
  id        String             @id
  userId    String
  plan      DaaSPlan           @default(BASIC)
  status    SubscriptionStatus @default(ACTIVE)
  apiKey    String             @unique
  rateLimit Int                @default(1000)
  createdAt DateTime           @default(now())
  updatedAt DateTime
  users     users              @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model execution_logs {
  id          String     @id
  executionId String
  level       LogLevel   @default(INFO)
  event       String
  message     String
  metadata    Json?
  timestamp   DateTime   @default(now())
  executions  executions @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([event])
  @@index([executionId])
  @@index([level])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model executions {
  id             String           @id
  sourceId       String
  status         ExecutionStatus  @default(PENDING)
  startedAt      DateTime         @default(now())
  completedAt    DateTime?
  duration       Int?
  itemsFound     Int              @default(0)
  itemsUpserted  Int              @default(0)
  errorMessage   String?
  ignoredAt      DateTime?
  ignoredBy      String?
  ignoredReason  String?
  execution_logs execution_logs[]
  sources        sources          @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([ignoredAt])
}

model feed_corrections {
  id                  String               @id
  feedId              String
  quarantinedRecordId String?
  recordRef           String
  field               String
  oldValue            String?
  newValue            String
  createdBy           String
  createdAt           DateTime             @default(now())
  retailerId          String
  retailer_feeds      retailer_feeds       @relation(fields: [feedId], references: [id], onDelete: Cascade)
  quarantined_records quarantined_records? @relation(fields: [quarantinedRecordId], references: [id])

  @@index([feedId, recordRef])
  @@index([quarantinedRecordId])
  @@index([retailerId])
}

model merchant_contacts {
  id                 String                @id
  merchantId         String
  firstName          String
  lastName           String
  email              String
  phone              String?
  marketingOptIn     Boolean               @default(false)
  communicationOptIn Boolean               @default(true)
  isAccountOwner     Boolean               @default(false)
  isActive           Boolean               @default(true)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime
  roles              MerchantContactRole[] @default([])
  merchants          merchants             @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, email], map: "dealer_contacts_dealerId_email_key")
  @@index([email], map: "dealer_contacts_email_idx")
}

model merchant_invites {
  id             String           @id
  merchantId     String
  email          String
  role           MerchantUserRole @default(MEMBER)
  inviteToken    String           @unique(map: "dealer_invites_inviteToken_key")
  invitedById    String
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime         @default(now())
  merchant_users merchant_users   @relation(fields: [invitedById], references: [id], map: "dealer_invites_invitedById_fkey")
  merchants      merchants        @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, email], map: "dealer_invites_dealerId_email_key")
}

model merchant_notification_prefs {
  id                 String    @id
  merchantId         String    @unique(map: "dealer_notification_prefs_dealerId_key")
  fatalFeedErrors    Boolean   @default(true)
  nonFatalFeedIssues Boolean   @default(false)
  successfulUpdates  Boolean   @default(false)
  weeklyPulse        Boolean   @default(true)
  insightAlerts      Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime
  merchants          merchants @relation(fields: [merchantId], references: [id], onDelete: Cascade)
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model merchant_retailers {
  id                      String                        @id
  merchantId              String
  retailerId              String
  status                  MerchantRetailerStatus        @default(ACTIVE)
  createdAt               DateTime                      @default(now())
  createdBy               String?
  updatedAt               DateTime
  listingStatus           MerchantRetailerListingStatus @default(UNLISTED)
  listedAt                DateTime?
  listedBy                String?
  unlistedAt              DateTime?
  unlistedBy              String?
  unlistedReason          String?
  merchants               merchants                     @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  retailers               retailers                     @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  merchant_user_retailers merchant_user_retailers[]

  @@unique([merchantId, retailerId])
  @@index([listingStatus])
  @@index([retailerId])
  @@index([status])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model merchant_user_retailers {
  id                 String               @id
  merchantUserId     String
  merchantRetailerId String
  role               MerchantRetailerRole @default(VIEWER)
  createdAt          DateTime             @default(now())
  createdBy          String?
  updatedAt          DateTime
  merchant_retailers merchant_retailers   @relation(fields: [merchantRetailerId], references: [id], onDelete: Cascade)

  @@unique([merchantUserId, merchantRetailerId])
  @@index([merchantRetailerId])
}

model merchant_users {
  id               String             @id
  merchantId       String
  email            String
  passwordHash     String
  name             String
  role             MerchantUserRole   @default(MEMBER)
  emailVerified    Boolean            @default(false)
  verifyToken      String?
  resetToken       String?
  resetTokenExp    DateTime?
  lastLoginAt      DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  merchant_invites merchant_invites[]
  merchants        merchants          @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, email])
  @@index([email], map: "dealer_users_email_idx")
}

model merchants {
  id                          String                       @id(map: "dealers_pkey")
  businessName                String
  websiteUrl                  String
  phone                       String?
  storeType                   StoreType                    @default(ONLINE_ONLY)
  status                      MerchantStatus               @default(PENDING)
  tier                        MerchantTier                 @default(FOUNDING)
  pixelApiKey                 String?                      @unique(map: "dealers_pixelApiKey_key")
  pixelEnabled                Boolean                      @default(false)
  shippingType                ShippingType                 @default(UNKNOWN)
  shippingFlat                Decimal?                     @db.Decimal(10, 2)
  shippingPerUnit             Decimal?                     @db.Decimal(10, 2)
  createdAt                   DateTime                     @default(now())
  updatedAt                   DateTime
  retailerId                  String?
  contactFirstName            String
  contactLastName             String
  lastSubscriptionNotifyAt    DateTime?
  subscriptionExpiresAt       DateTime?
  subscriptionGraceDays       Int                          @default(7)
  subscriptionStatus          MerchantSubscriptionStatus   @default(ACTIVE)
  autoRenew                   Boolean                      @default(true)
  paymentMethod               MerchantPaymentMethod?
  stripeCustomerId            String?                      @unique(map: "dealers_stripeCustomerId_key")
  stripeSubscriptionId        String?                      @unique(map: "dealers_stripeSubscriptionId_key")
  merchant_contacts           merchant_contacts[]
  merchant_invites            merchant_invites[]
  merchant_notification_prefs merchant_notification_prefs?
  merchant_retailers          merchant_retailers[]
  merchant_users              merchant_users[]
  pixel_events                pixel_events[]
  prices                      prices[]
}

model pixel_events {
  id            String    @id
  merchantId    String
  orderId       String
  orderValue    Decimal   @db.Decimal(10, 2)
  orderCurrency String    @default("USD")
  skuList       Json?
  clickEventId  String?
  attributedAt  DateTime?
  userAgent     String?
  ipHash        String?
  referrer      String?
  createdAt     DateTime  @default(now())
  merchants     merchants @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([merchantId])
  @@index([orderId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model price_corrections {
  id           String                   @id
  scopeType    PriceCorrectionScopeType
  scopeId      String
  startTs      DateTime                 @db.Timestamptz(6)
  endTs        DateTime                 @db.Timestamptz(6)
  action       PriceCorrectionAction
  value        Decimal?                 @db.Decimal(10, 4)
  reason       String
  createdAt    DateTime                 @default(now()) @db.Timestamptz(6)
  createdBy    String
  revokedAt    DateTime?                @db.Timestamptz(6)
  revokedBy    String?
  revokeReason String?

  @@index([createdAt])
  @@index([revokedAt])
  @@index([scopeType, scopeId])
  @@index([startTs, endTs])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model prices {
  id                  String               @id
  productId           String?
  retailerId          String
  price               Decimal              @db.Decimal(10, 2)
  currency            String               @default("USD")
  url                 String
  inStock             Boolean              @default(true)
  createdAt           DateTime             @default(now())
  freeShippingMinimum Decimal?             @db.Decimal(10, 2)
  shippingCost        Decimal?             @db.Decimal(10, 2)
  shippingNotes       String?
  originalPrice       Decimal?             @db.Decimal(10, 2)
  priceType           PriceType?
  saleStartsAt        DateTime?
  saleEndsAt          DateTime?
  affiliateFeedRunId  String?
  priceSignatureHash  String?
  sourceProductId     String?
  ingestionRunType    IngestionRunType?
  ingestionRunId      String?
  affiliateId         String?
  observedAt          DateTime             @default(now()) @db.Timestamptz(6)
  merchantId          String?
  sourceId            String?
  retailerSkuId       String?
  affiliate_feed_runs affiliate_feed_runs? @relation(fields: [affiliateFeedRunId], references: [id])
  merchants           merchants?           @relation(fields: [merchantId], references: [id])
  products            products?            @relation(fields: [productId], references: [id], onDelete: Cascade)
  retailers           retailers            @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  retailer_skus       retailer_skus?       @relation(fields: [retailerSkuId], references: [id])
  sources             sources?             @relation(fields: [sourceId], references: [id])
  source_products     source_products?     @relation(fields: [sourceProductId], references: [id])
  product_reports     product_reports[]

  @@index([inStock])
  @@index([ingestionRunId])
  @@index([merchantId])
  @@index([observedAt])
  @@index([productId])
  @@index([retailerId])
  @@index([retailerSkuId])
  @@index([sourceId])
  @@index([sourceProductId])
}

model product_aliases {
  id                                               String   @id
  fromProductId                                    String   @unique
  toProductId                                      String
  reason                                           String
  createdAt                                        DateTime @default(now())
  createdBy                                        String?
  products_product_aliases_fromProductIdToproducts products @relation("product_aliases_fromProductIdToproducts", fields: [fromProductId], references: [id])
  products_product_aliases_toProductIdToproducts   products @relation("product_aliases_toProductIdToproducts", fields: [toProductId], references: [id])

  @@index([toProductId])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model product_links {
  id              String                 @id
  sourceProductId String                 @unique
  productId       String?
  matchType       ProductLinkMatchType
  status          ProductLinkStatus
  reasonCode      ProductLinkReasonCode?
  confidence      Decimal                @db.Decimal(5, 4)
  resolverVersion String
  evidence        Json
  resolvedAt      DateTime?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime
  products        products?              @relation(fields: [productId], references: [id])
  source_products source_products        @relation(fields: [sourceProductId], references: [id], onDelete: Cascade)

  @@index([matchType])
  @@index([productId])
  @@index([resolvedAt])
  @@index([resolverVersion])
  @@index([status, matchType])
}

model product_reports {
  id          String           @id
  productId   String
  userId      String?
  priceId     String?
  issueType   ProductIssueType
  description String
  status      ReportStatus     @default(PENDING)
  reviewedBy  String?
  reviewNotes String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime
  resolvedAt  DateTime?
  prices      prices?          @relation(fields: [priceId], references: [id])
  products    products         @relation(fields: [productId], references: [id], onDelete: Cascade)
  users       users?           @relation(fields: [userId], references: [id])
}

model product_resolve_requests {
  id              String                      @id
  idempotencyKey  String                      @unique
  sourceProductId String
  sourceId        String
  status          ProductResolveRequestStatus @default(PENDING)
  attempts        Int                         @default(0)
  lastAttemptAt   DateTime?
  errorMessage    String?
  resultProductId String?
  createdAt       DateTime                    @default(now())
  updatedAt       DateTime                    @default(now())
  products        products?                   @relation(fields: [resultProductId], references: [id])
  sources         sources                     @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  source_products source_products             @relation(fields: [sourceProductId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([sourceId])
  @@index([sourceProductId])
  @@index([status, updatedAt])
}

model products {
  id                                                      String                     @id
  name                                                    String
  description                                             String?
  category                                                String
  brand                                                   String?
  imageUrl                                                String?
  upc                                                     String?                    @unique
  caliber                                                 String?
  grainWeight                                             Int?
  caseMaterial                                            String?
  purpose                                                 String?
  roundCount                                              Int?
  metadata                                                Json?
  createdAt                                               DateTime                   @default(now())
  updatedAt                                               DateTime
  embedding                                               Unsupported("vector")?
  barrelLengthReference                                   Decimal?                   @db.Decimal(4, 2)
  bulletType                                              BulletType?
  controlledExpansion                                     Boolean?
  dataConfidence                                          Decimal?                   @db.Decimal(3, 2)
  dataSource                                              DataSource?                @default(UNKNOWN)
  factoryNew                                              Boolean?                   @default(true)
  isSubsonic                                              Boolean?
  lowFlash                                                Boolean?
  lowRecoil                                               Boolean?
  matchGrade                                              Boolean?
  muzzleVelocityFps                                       Int?
  pressureRating                                          PressureRating?            @default(STANDARD)
  shortBarrelOptimized                                    Boolean?
  suppressorSafe                                          Boolean?
  canonicalKey                                            String?                    @unique
  upcNorm                                                 String?                    @unique
  brandNorm                                               String?
  caliberNorm                                             String?
  specs                                                   Json?
  lastEmbeddedAt                                          DateTime?
  alerts                                                  alerts[]
  prices                                                  prices[]
  product_aliases_product_aliases_fromProductIdToproducts product_aliases?           @relation("product_aliases_fromProductIdToproducts")
  product_aliases_product_aliases_toProductIdToproducts   product_aliases[]          @relation("product_aliases_toProductIdToproducts")
  product_links                                           product_links[]
  product_reports                                         product_reports[]
  product_resolve_requests                                product_resolve_requests[]
  watchlist_items                                         watchlist_items[]

  @@index([brandNorm, caliberNorm])
  @@index([bulletType])
  @@index([caliber])
  @@index([isSubsonic])
  @@index([pressureRating])
  @@index([purpose])
}

model quarantined_records {
  id               String             @id
  feedId           String
  runId            String?
  productType      String?
  matchKey         String
  rawData          Json
  parsedFields     Json?
  blockingErrors   Json
  status           QuarantineStatus   @default(QUARANTINED)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  retailerId       String?
  feedType         QuarantineFeedType @default(RETAILER)
  sourceId         String?
  feed_corrections feed_corrections[]

  @@unique([feedId, matchKey])
  @@index([feedId, status])
  @@index([feedType])
  @@index([retailerId])
  @@index([sourceId])
  @@index([status])
}

model retailer_feed_runs {
  id               String         @id(map: "dealer_feed_runs_pkey")
  feedId           String
  status           FeedRunStatus
  errors           Json?
  rowCount         Int            @default(0)
  duration         Int?
  startedAt        DateTime       @default(now())
  completedAt      DateTime?
  primaryErrorCode String?
  quarantinedCount Int            @default(0)
  coercionCount    Int            @default(0)
  errorCodes       Json?
  indexedCount     Int            @default(0)
  rejectedCount    Int            @default(0)
  matchedCount     Int            @default(0)
  retailerId       String?
  retailer_feeds   retailer_feeds @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@index([startedAt], map: "dealer_feed_runs_startedAt_idx")
  @@index([feedId], map: "merchant_feed_runs_feedId_idx")
  @@index([feedId])
  @@index([retailerId])
}

model retailer_feed_test_runs {
  id               String         @id(map: "dealer_feed_test_runs_pkey")
  feedId           String
  sampleSize       Int            @default(50)
  status           TestRunStatus
  recordsParsed    Int            @default(0)
  wouldIndex       Int            @default(0)
  wouldQuarantine  Int            @default(0)
  wouldReject      Int            @default(0)
  warningCount     Int            @default(0)
  errorCount       Int            @default(0)
  primaryErrorCode String?
  errorSamples     Json?
  coercionSummary  Json?
  duration         Int?
  startedAt        DateTime       @default(now())
  completedAt      DateTime?
  retailerId       String
  retailer_feeds   retailer_feeds @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@index([feedId])
  @@index([retailerId])
  @@index([startedAt])
}

model retailer_feeds {
  id                      String                    @id(map: "dealer_feeds_pkey")
  name                    String?
  url                     String?
  username                String?
  password                String?
  scheduleMinutes         Int                       @default(60)
  status                  FeedStatus                @default(PENDING)
  feedHash                String?
  lastSuccessAt           DateTime?
  lastFailureAt           DateTime?
  lastError               String?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  accessType              FeedAccessType            @default(URL)
  enabled                 Boolean                   @default(true)
  formatType              FeedFormatType            @default(GENERIC)
  lastRunAt               DateTime?
  primaryErrorCode        String?
  retailerId              String?
  feed_corrections        feed_corrections[]
  retailer_feed_runs      retailer_feed_runs[]
  retailer_feed_test_runs retailer_feed_test_runs[]
  retailers               retailers?                @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  retailer_skus           retailer_skus[]

  @@index([enabled], map: "dealer_feeds_enabled_idx")
  @@index([retailerId])
}

model retailer_skus {
  id               String          @id(map: "dealer_skus_pkey")
  feedId           String?
  feedRunId        String?
  rawTitle         String
  rawDescription   String?
  rawPrice         Decimal         @db.Decimal(10, 2)
  rawUpc           String?
  rawSku           String?
  rawCaliber       String?
  rawGrain         String?
  rawCase          String?
  rawBulletType    String?
  rawBrand         String?
  rawPackSize      Int?
  rawInStock       Boolean         @default(true)
  rawUrl           String?
  rawImageUrl      String?
  canonicalSkuId   String?
  parsedCaliber    String?
  parsedGrain      Int?
  parsedPackSize   Int?
  parsedBulletType String?
  parsedBrand      String?
  parseConfidence  Decimal?        @db.Decimal(3, 2)
  retailerSkuHash  String?
  isActive         Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime
  lastSeenAt       DateTime?
  missingCount     Int             @default(0)
  productType      String?
  coercionsApplied Json?
  retailerId       String?
  contentHash      String?
  prices           prices[]
  retailer_feeds   retailer_feeds? @relation(fields: [feedId], references: [id], map: "dealer_skus_feedId_fkey")
  retailers        retailers?      @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  @@unique([retailerId, retailerSkuHash])
  @@index([isActive], map: "dealer_skus_isActive_idx")
  @@index([feedId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model retailers {
  id                  String               @id
  name                String
  website             String               @unique
  logoUrl             String?
  tier                RetailerTier         @default(STANDARD)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime
  visibilityStatus    RetailerVisibility   @default(ELIGIBLE)
  visibilityReason    String?
  visibilityUpdatedAt DateTime?
  visibilityUpdatedBy String?
  click_events        click_events[]
  merchant_retailers  merchant_retailers[]
  prices              prices[]
  retailer_feeds      retailer_feeds[]
  retailer_skus       retailer_skus[]
  sources             sources[]
  subscriptions       subscriptions[]

  @@index([visibilityStatus])
}

model source_product_identifiers {
  id              String         @id @default(dbgenerated("(gen_random_uuid())::text"))
  sourceProductId String
  idType          IdentifierType
  idValue         String
  namespace       String         @default("")
  isCanonical     Boolean        @default(false)
  normalizedValue String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @default(now())

  @@unique([sourceProductId, idType, idValue, namespace], map: "source_product_identifiers_unique")
  @@index([sourceProductId, isCanonical], map: "source_product_identifiers_canonical")
  @@index([idType, idValue, namespace], map: "source_product_identifiers_lookup")
}

model source_product_presence {
  id                String          @id
  sourceProductId   String          @unique
  lastSeenAt        DateTime
  lastSeenSuccessAt DateTime?
  updatedAt         DateTime
  source_products   source_products @relation(fields: [sourceProductId], references: [id], onDelete: Cascade)

  @@index([lastSeenSuccessAt])
}

model source_product_seen {
  id                  String              @id
  runId               String
  sourceProductId     String
  createdAt           DateTime            @default(now())
  affiliate_feed_runs affiliate_feed_runs @relation(fields: [runId], references: [id], onDelete: Cascade)
  source_products     source_products     @relation(fields: [sourceProductId], references: [id], onDelete: Cascade)

  @@unique([runId, sourceProductId])
}

model source_products {
  id                       String                     @id
  sourceId                 String
  title                    String
  url                      String
  imageUrl                 String?
  normalizedUrl            String?
  createdByRunId           String?
  lastUpdatedByRunId       String?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  productId                String?
  brand                    String?
  description              String?
  category                 String?
  normalizedHash           String?
  identityKey              String?
  caliber                  String?
  grainWeight              Int?
  roundCount               Int?
  brandNorm                String?
  click_events             click_events[]
  prices                   prices[]
  product_links            product_links?
  product_resolve_requests product_resolve_requests[]
  source_product_presence  source_product_presence?
  source_product_seen      source_product_seen[]
  sources                  sources                    @relation(fields: [sourceId], references: [id])

  @@index([brandNorm, createdAt])
  @@index([identityKey])
  @@index([normalizedHash])
  @@index([productId])
  @@index([sourceId])
}

model source_trust_config {
  id         String   @id
  sourceId   String   @unique
  upcTrusted Boolean  @default(false)
  version    Int      @default(1)
  updatedAt  DateTime
  updatedBy  String?
  sources    sources  @relation(fields: [sourceId], references: [id], onDelete: Cascade)
}

model sources {
  id                        String                     @id
  name                      String
  url                       String
  type                      SourceType                 @default(HTML)
  enabled                   Boolean                    @default(true)
  interval                  Int                        @default(3600)
  lastRunAt                 DateTime?
  paginationConfig          Json?
  affiliateNetwork          AffiliateNetwork?
  feedHash                  String?
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime
  retailerId                String
  affiliateAccountId        String?
  affiliateAccountName      String?
  affiliateAdvertiserId     String?
  affiliateCampaignId       String?
  affiliateProgramId        String?
  affiliateTrackingTemplate String?
  isDisplayPrimary          Boolean                    @default(false)
  sourceKind                SourceKind                 @default(DIRECT)
  affiliate_feeds           affiliate_feeds[]
  click_events              click_events[]
  executions                executions[]
  prices                    prices[]
  product_resolve_requests  product_resolve_requests[]
  source_products           source_products[]
  source_trust_config       source_trust_config?
  retailers                 retailers                  @relation(fields: [retailerId], references: [id])

  @@index([retailerId], map: "sources_retailer_id_idx")
}

model subscriptions {
  id         String             @id
  userId     String?
  retailerId String?
  type       SubscriptionType
  status     SubscriptionStatus @default(ACTIVE)
  startDate  DateTime           @default(now())
  endDate    DateTime?
  amount     Decimal            @db.Decimal(10, 2)
  currency   String             @default("USD")
  stripeId   String?            @unique
  retailers  retailers?         @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  users      users?             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model system_settings {
  key         String   @id
  value       Json
  description String?
  updatedAt   DateTime
  updatedBy   String?
}

model users {
  id                    String                  @id
  email                 String                  @unique
  name                  String?
  image                 String?
  password              String?
  emailVerified         DateTime?
  tier                  UserTier                @default(FREE)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  deletionRequestedAt   DateTime?
  deletionScheduledFor  DateTime?
  status                UserStatus              @default(ACTIVE)
  Account               Account[]
  Session               Session[]
  alerts                alerts[]
  data_subscriptions    data_subscriptions[]
  product_reports       product_reports[]
  subscriptions         subscriptions[]
  user_guns             user_guns[]
  watchlist_collections watchlist_collections[]
  watchlist_items       watchlist_items[]
}

/// Gun Locker - stores guns a user owns for deal personalization
model user_guns {
  id        String   @id
  userId    String
  caliber   String   // Canonical caliber value from CaliberEnum
  nickname  String?
  createdAt DateTime @default(now())
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model watchlist_collections {
  id              String            @id
  userId          String
  name            String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  users           users             @relation(fields: [userId], references: [id], onDelete: Cascade)
  watchlist_items watchlist_items[]

  @@index([userId])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model watchlist_items {
  id                            String                 @id
  userId                        String
  productId                     String?
  collectionId                  String?
  createdAt                     DateTime               @default(now())
  updatedAt                     DateTime
  notificationsEnabled          Boolean                @default(true)
  priceDropEnabled              Boolean                @default(true)
  backInStockEnabled            Boolean                @default(true)
  minDropPercent                Int                    @default(5)
  minDropAmount                 Decimal                @default(5.0) @db.Decimal(10, 2)
  stockAlertCooldownHours       Int                    @default(24)
  lastStockNotifiedAt           DateTime?
  lastPriceNotifiedAt           DateTime?
  intent_type                   String                 @default("SKU")
  query_snapshot                Json?
  deleted_at                    DateTime?              @db.Timestamp(6)
  price_notification_claimed_at DateTime?
  price_notification_claim_key  String?
  stock_notification_claimed_at DateTime?
  stock_notification_claim_key  String?
  alerts                        alerts[]
  watchlist_collections         watchlist_collections? @relation(fields: [collectionId], references: [id])
  products                      products?              @relation(fields: [productId], references: [id], onDelete: Cascade)
  users                         users                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([collectionId])
  @@index([deleted_at])
  @@index([intent_type])
  @@index([productId])
  @@index([userId])
}

enum AdType {
  DISPLAY
  SPONSORED_PRODUCT
  BANNER
}

enum AffiliateFeedRunStatus {
  RUNNING
  SUCCEEDED
  FAILED
}

enum AffiliateFeedRunTrigger {
  SCHEDULED
  MANUAL
  MANUAL_PENDING
  ADMIN_TEST
  RETRY
}

enum AffiliateFeedStatus {
  DRAFT
  ENABLED
  PAUSED
  DISABLED
}

enum AffiliateNetwork {
  IMPACT
  AVANTLINK
  SHAREASALE
  CJ
  RAKUTEN
}

enum AlertRuleType {
  PRICE_DROP
  BACK_IN_STOCK
}

enum AlertType {
  PRICE_DROP
  BACK_IN_STOCK
  NEW_PRODUCT
}

enum BenchmarkConfidence {
  HIGH
  MEDIUM
  NONE
}

enum BrandAliasSourceType {
  RETAILER_FEED
  AFFILIATE_FEED
  MANUAL
}

enum BrandAliasStatus {
  DRAFT
  ACTIVE
  DISABLED
}

enum BulletType {
  JHP
  HP
  BJHP
  XTP
  HST
  GDHP
  VMAX
  FMJ
  TMJ
  CMJ
  MC
  BALL
  SP
  JSP
  PSP
  RN
  FPRN
  FRANGIBLE
  AP
  TRACER
  BLANK
  WADCUTTER
  SWC
  LSWC
  BUCKSHOT
  BIRDSHOT
  SLUG
  OTHER
}

enum DaaSPlan {
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum DataSource {
  MANUFACTURER
  RETAILER_FEED
  PARSED
  MANUAL
  AI_INFERRED
  UNKNOWN
}

enum ExecutionStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

enum FeedAccessType {
  URL
  AUTH_URL
  FTP
  SFTP
  UPLOAD
}

enum FeedCompression {
  NONE
  GZIP
}

enum FeedFormat {
  CSV
}

enum FeedFormatType {
  GENERIC
  AMMOSEEK_V1
  GUNENGINE_V2
  IMPACT
}

enum FeedRunStatus {
  RUNNING
  SUCCESS
  WARNING
  FAILURE
  PENDING
  SKIPPED
}

enum FeedStatus {
  PENDING
  HEALTHY
  WARNING
  FAILED
}

enum FeedTransport {
  FTP
  SFTP
}

enum FeedVariant {
  FULL
  DELTA
  REGIONAL_US
  REGIONAL_CA
  REGIONAL_EU
  CATEGORY_AMMO
  CATEGORY_ACCESSORIES
}

enum IdentifierType {
  SKU
  UPC
  EAN
  GTIN
  MPN
  ASIN
  URL
  URL_HASH
  NETWORK_ITEM_ID
  MERCHANT_SKU
  INTERNAL_ID
}

enum IngestionRunType {
  SCRAPE
  AFFILIATE_FEED
  RETAILER_FEED
  MANUAL
}

enum LogLevel {
  INFO
  WARN
  ERROR
}

enum MerchantContactRole {
  PRIMARY
  BILLING
  TECHNICAL
  MARKETING
  OTHER
}

enum MerchantPaymentMethod {
  STRIPE
  PURCHASE_ORDER
}

enum MerchantRetailerListingStatus {
  LISTED
  UNLISTED
}

enum MerchantRetailerRole {
  ADMIN
  EDITOR
  VIEWER
}

enum MerchantRetailerStatus {
  ACTIVE
  PENDING
  SUSPENDED
  INACTIVE
}

enum MerchantStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum MerchantSubscriptionStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
  CANCELLED
}

enum MerchantTier {
  FOUNDING
  BASIC
  PRO
  ENTERPRISE
}

enum MerchantUserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum PressureRating {
  STANDARD
  PLUS_P
  PLUS_P_PLUS
  NATO
  UNKNOWN
}

enum PriceCorrectionAction {
  IGNORE
  MULTIPLIER
}

enum PriceCorrectionScopeType {
  PRODUCT
  RETAILER
  MERCHANT
  SOURCE
  AFFILIATE
  FEED_RUN
}

enum PriceType {
  REGULAR
  SALE
  CLEARANCE
}

enum ProductIssueType {
  INCORRECT_PRICE
  OUT_OF_STOCK
  INCORRECT_INFO
  BROKEN_LINK
  WRONG_PRODUCT
  SPAM
  OTHER
}

enum ProductLinkMatchType {
  UPC
  FINGERPRINT
  MANUAL
  NONE
  ERROR
}

enum ProductLinkReasonCode {
  INSUFFICIENT_DATA
  INVALID_UPC
  UPC_NOT_TRUSTED
  AMBIGUOUS_FINGERPRINT
  CONFLICTING_IDENTIFIERS
  MANUAL_LOCKED
  RELINK_BLOCKED_HYSTERESIS
  SYSTEM_ERROR
  NORMALIZATION_FAILED
}

enum ProductLinkStatus {
  MATCHED
  CREATED
  UNMATCHED
  NEEDS_REVIEW
  ERROR
  SKIPPED
}

enum ProductResolveRequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ProductSuggestionSourceType {
  MERCHANT
  AFFILIATE
  INTERNAL
}

enum ProductSuggestionStatus {
  PENDING
  APPROVED
  REJECTED
  MERGED
}

enum QuarantineFeedType {
  RETAILER
  AFFILIATE
}

enum QuarantineStatus {
  QUARANTINED
  RESOLVED
  DISMISSED
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

enum RetailerTier {
  STANDARD
  PREMIUM
}

enum RetailerVisibility {
  ELIGIBLE
  INELIGIBLE
  SUSPENDED
}

enum ShippingType {
  FLAT
  PER_UNIT
  CALCULATED
  FREE
  UNKNOWN
}

enum SourceKind {
  DIRECT
  AFFILIATE_FEED
  OTHER
}

enum SourceType {
  HTML
  JS_RENDERED
  RSS
  JSON
  FEED_CSV
  FEED_XML
  FEED_JSON
}

enum StoreType {
  ONLINE_ONLY
  RETAIL_AND_ONLINE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

enum SubscriptionType {
  USER_PREMIUM
  RETAILER_PREMIUM
}

enum TestRunStatus {
  PASS
  WARN
  FAIL
}

enum UserStatus {
  ACTIVE
  PENDING_DELETION
  DELETED
}

enum UserTier {
  FREE
  PREMIUM
}
