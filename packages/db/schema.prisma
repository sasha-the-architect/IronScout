// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  image     String?
  password  String?  // For email/password authentication (hashed with bcrypt)
  emailVerified DateTime?
  tier      UserTier @default(FREE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  alerts        Alert[]
  subscriptions Subscription[]
  accounts      Account[]
  sessions      Session[]
  reports       ProductReport[]

  // POST-MVP FEATURE: Not for initial implementation
  dataSubscriptions DataSubscription[]

  @@map("users")
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String
  brand       String?
  imageUrl    String?

  // =============================================
  // Core Ammo Attributes (Always Required)
  // =============================================
  upc          String?  @unique
  caliber      String?  // e.g., "9mm", ".223 Remington", "12 Gauge"
  grainWeight  Int?     // Bullet weight in grains
  caseMaterial String?  // e.g., "Brass", "Steel", "Aluminum"
  purpose      String?  // e.g., "Target", "Defense", "Hunting"
  roundCount   Int?     // Rounds per box/case

  // =============================================
  // Ballistic Performance Fields (Premium Filters)
  // =============================================
  
  // Bullet construction type - critical for purpose matching
  bulletType     BulletType?      // JHP, FMJ, SP, etc.
  
  // Pressure rating - affects +P filtering and safety recommendations
  pressureRating PressureRating?  @default(STANDARD)
  
  // Velocity data - used for subsonic detection, expansion thresholds
  muzzleVelocityFps    Int?       // Muzzle velocity in feet per second
  barrelLengthReference Decimal?  @db.Decimal(4, 2) // Barrel length (inches) used for velocity measurement
  
  // Subsonic indicator - for suppressor use and reduced noise
  // Can be computed from velocity (<1125 fps) or explicitly set
  isSubsonic     Boolean?
  
  // =============================================
  // Optimization Flags (Premium AI Features)
  // =============================================
  
  // Short barrel optimization (<4" barrels) - affects defensive ammo recommendations
  shortBarrelOptimized Boolean?
  
  // Suppressor compatibility
  suppressorSafe      Boolean?    // Won't damage suppressors
  
  // Safety characteristics for defensive use
  lowFlash            Boolean?    // Reduced muzzle flash (indoor/low-light)
  lowRecoil           Boolean?    // Reduced felt recoil
  controlledExpansion Boolean?    // Designed to limit overpenetration
  
  // Quality indicators
  matchGrade          Boolean?    // Match/competition quality
  factoryNew          Boolean?    @default(true) // Not remanufactured
  
  // =============================================
  // Data Quality Tracking
  // =============================================
  
  // How the ballistic data was populated
  dataSource     DataSource?      @default(UNKNOWN)
  dataConfidence Decimal?         @db.Decimal(3, 2) // 0.00-1.00 confidence score
  
  // =============================================
  // Flexible Metadata (Future Extensibility)
  // =============================================
  metadata    Json?    // Additional data without schema changes

  // Vector embedding for semantic search (1536 dimensions for OpenAI text-embedding-3-small)
  embedding   Unsupported("vector(1536)")?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  prices  Price[]
  alerts  Alert[]
  reports ProductReport[]
  
  // Dealer portal link
  canonicalSkus CanonicalSku[]

  // Indexes for premium filter queries
  @@index([caliber])
  @@index([bulletType])
  @@index([pressureRating])
  @@index([isSubsonic])
  @@index([purpose])
  @@map("products")
}

model Retailer {
  id          String      @id @default(cuid())
  name        String
  website     String      @unique
  logoUrl     String?
  tier        RetailerTier @default(STANDARD)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  prices        Price[]
  subscriptions Subscription[]
  
  // Dealer portal link
  dealer        Dealer?

  @@map("retailers")
}

model Price {
  id         String   @id @default(cuid())
  productId  String
  retailerId String
  price      Decimal  @db.Decimal(10, 2)
  currency   String   @default("USD")
  url        String
  inStock    Boolean  @default(true)

  // Shipping & Handling
  shippingCost         Decimal? @db.Decimal(10, 2) // Null means free shipping or unknown
  freeShippingMinimum  Decimal? @db.Decimal(10, 2) // Minimum order for free shipping
  shippingNotes        String?  // e.g., "Free shipping for Prime members"

  createdAt  DateTime @default(now())

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  retailer Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  reports  ProductReport[]

  @@index([productId])
  @@index([retailerId])
  @@index([inStock])
  @@map("prices")
}

model Alert {
  id            String      @id @default(cuid())
  userId        String
  productId     String
  targetPrice   Decimal?    @db.Decimal(10, 2)
  isActive      Boolean     @default(true)
  alertType     AlertType   @default(PRICE_DROP)
  lastTriggered DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("alerts")
}

model Advertisement {
  id          String   @id @default(cuid())
  title       String
  description String
  imageUrl    String?
  targetUrl   String
  adType      AdType   @default(DISPLAY)
  isActive    Boolean  @default(true)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("advertisements")
}

model ProductReport {
  id          String             @id @default(cuid())
  productId   String
  userId      String?            // Nullable to allow anonymous reports
  priceId     String?            // Specific price/retailer if issue is retailer-specific
  issueType   ProductIssueType
  description String             // User's description of the issue
  status      ReportStatus       @default(PENDING)
  reviewedBy  String?            // Admin user ID who reviewed
  reviewNotes String?            // Admin notes
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  resolvedAt  DateTime?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  price   Price?  @relation(fields: [priceId], references: [id], onDelete: SetNull)

  @@map("product_reports")
}

model Source {
  id                String            @id @default(cuid())
  name              String
  url               String            // Feed URL or scrape target
  type              SourceType        @default(HTML)
  enabled           Boolean           @default(true)
  interval          Int               @default(3600) // seconds between crawls (feeds: 43200=12h, scrapers: 3600=1h)
  lastRunAt         DateTime?
  paginationConfig  Json?             // { type: "none"|"query_param"|"path", maxPages: 100, param: "page", startValue: 1, increment: 1 }

  // Affiliate feed configuration
  affiliateNetwork  AffiliateNetwork? // Which affiliate network (for feeds only)
  feedHash          String?           // Hash of last fetched feed (for change detection)

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  executions  Execution[]

  @@map("sources")
}

model Execution {
  id            String          @id @default(cuid())
  sourceId      String
  status        ExecutionStatus @default(PENDING)
  startedAt     DateTime        @default(now())
  completedAt   DateTime?
  duration      Int?            // milliseconds
  itemsFound    Int             @default(0)
  itemsUpserted Int             @default(0)
  errorMessage  String?

  source Source           @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  logs   ExecutionLog[]

  @@map("executions")
}

model ExecutionLog {
  id          String    @id @default(cuid())
  executionId String
  level       LogLevel  @default(INFO)
  event       String
  message     String
  metadata    Json?
  timestamp   DateTime  @default(now())

  execution Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@map("execution_logs")
  @@index([executionId])
  @@index([level])
  @@index([event])
}

model Subscription {
  id         String           @id @default(cuid())
  userId     String?
  retailerId String?
  type       SubscriptionType
  status     SubscriptionStatus @default(ACTIVE)
  startDate  DateTime         @default(now())
  endDate    DateTime?
  amount     Decimal          @db.Decimal(10, 2)
  currency   String           @default("USD")
  stripeId   String?          @unique

  user     User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  retailer Retailer? @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// POST-MVP FEATURE: Not for initial implementation
model DataSubscription {
  id        String   @id @default(cuid())
  userId    String
  plan      DaaSPlan @default(BASIC)
  status    SubscriptionStatus @default(ACTIVE)
  apiKey    String   @unique
  rateLimit Int      @default(1000)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("data_subscriptions")
}

// POST-MVP FEATURE: Not for initial implementation
model MarketReport {
  id          String   @id @default(cuid())
  productId   String?
  category    String
  reportType  String
  data        Json
  generatedAt DateTime @default(now())

  @@map("market_reports")
}

// =============================================
// Enums
// =============================================

enum UserTier {
  FREE
  PREMIUM
}

enum RetailerTier {
  STANDARD
  PREMIUM
}

enum AlertType {
  PRICE_DROP
  BACK_IN_STOCK
  NEW_PRODUCT
}

enum AdType {
  DISPLAY
  SPONSORED_PRODUCT
  BANNER
}

enum SubscriptionType {
  USER_PREMIUM
  RETAILER_PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

enum ExecutionStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

enum LogLevel {
  INFO
  WARN
  ERROR
}

enum SourceType {
  // Scraper types (web scraping)
  HTML          // Static HTML scraping
  JS_RENDERED   // JavaScript-rendered pages (Playwright)
  RSS           // RSS feeds
  JSON          // JSON APIs

  // Affiliate feed types
  FEED_CSV      // CSV affiliate feeds
  FEED_XML      // XML affiliate feeds
  FEED_JSON     // JSON affiliate feeds
}

enum AffiliateNetwork {
  IMPACT        // Impact Radius
  AVANTLINK     // AvantLink
  SHAREASALE    // ShareASale
  CJ            // Commission Junction
  RAKUTEN       // Rakuten Advertising
}

enum ProductIssueType {
  INCORRECT_PRICE      // Price is wrong
  OUT_OF_STOCK         // Listed as in stock but actually out
  INCORRECT_INFO       // Wrong product details (caliber, grain, etc.)
  BROKEN_LINK          // URL doesn't work
  WRONG_PRODUCT        // Link goes to different product
  SPAM                 // Spam or inappropriate content
  OTHER                // Other issue (described in description field)
}

enum ReportStatus {
  PENDING              // Awaiting review
  UNDER_REVIEW         // Being investigated
  RESOLVED             // Issue fixed
  DISMISSED            // Not an issue or cannot fix
}

// POST-MVP FEATURE: Not for initial implementation
enum DaaSPlan {
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

// =============================================
// Ammunition-Specific Enums
// =============================================

// Bullet construction types - critical for purpose matching
enum BulletType {
  // Hollow Points (Defensive)
  JHP           // Jacketed Hollow Point - most common defensive
  HP            // Hollow Point (unjacketed)
  BJHP          // Bonded Jacketed Hollow Point - barrier blind
  XTP           // eXtreme Terminal Performance (Hornady)
  HST           // Hi-Shok Two (Federal HST)
  GDHP          // Gold Dot Hollow Point (Speer)
  VMAX          // V-Max (Hornady varmint)
  
  // Full Metal Jacket (Training/Target)
  FMJ           // Full Metal Jacket - most common training
  TMJ           // Total Metal Jacket - fully encapsulated
  CMJ           // Complete Metal Jacket
  MC            // Metal Case (same as FMJ)
  BALL          // Military ball ammo
  
  // Soft Point (Hunting/General)
  SP            // Soft Point
  JSP           // Jacketed Soft Point
  PSP           // Pointed Soft Point
  RN            // Round Nose
  FPRN          // Flat Point Round Nose
  
  // Specialty
  FRANGIBLE     // Breaks apart on impact (training, CQB)
  AP            // Armor Piercing
  TRACER        // Tracer rounds
  BLANK         // Blank rounds
  WADCUTTER     // Target/competition (revolver)
  SWC           // Semi-Wadcutter
  LSWC          // Lead Semi-Wadcutter
  
  // Shotgun specific
  BUCKSHOT      // Buckshot
  BIRDSHOT      // Birdshot
  SLUG          // Slug
  
  // Unknown/Other
  OTHER
}

// Pressure rating levels
enum PressureRating {
  STANDARD      // Standard pressure
  PLUS_P        // +P (higher pressure, ~10% more)
  PLUS_P_PLUS   // +P+ (even higher, LEO/military)
  NATO          // NATO spec (similar to +P)
  UNKNOWN
}

// How the product data was sourced/populated
enum DataSource {
  MANUFACTURER  // Direct from manufacturer specs
  RETAILER_FEED // From retailer/affiliate feed
  PARSED        // Parsed from product name/description
  MANUAL        // Manually entered/verified
  AI_INFERRED   // AI-inferred from context
  UNKNOWN
}

// =============================================
// DEALER PORTAL MODELS
// =============================================

model Dealer {
  id              String        @id @default(cuid())
  
  // Business info
  businessName    String
  contactName     String
  websiteUrl      String
  phone           String?
  storeType       StoreType     @default(ONLINE_ONLY)
  
  // Status & tier
  status          DealerStatus  @default(PENDING)
  tier            DealerTier    @default(FOUNDING)
  
  // Pixel tracking
  pixelApiKey     String?       @unique
  pixelEnabled    Boolean       @default(false)
  
  // Shipping config
  shippingType    ShippingType  @default(UNKNOWN)
  shippingFlat    Decimal?      @db.Decimal(10, 2)
  shippingPerUnit Decimal?      @db.Decimal(10, 2)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Team members
  users           DealerUser[]
  invites         DealerInvite[]
  
  feeds           DealerFeed[]
  skus            DealerSku[]
  insights        DealerInsight[]
  pixelEvents     PixelEvent[]
  clickEvents     ClickEvent[]
  notificationPref DealerNotificationPref?
  
  // Link to Retailer (for buyer-facing listings)
  retailer        Retailer?     @relation(fields: [retailerId], references: [id])
  retailerId      String?       @unique

  @@map("dealers")
}

model DealerUser {
  id              String          @id @default(cuid())
  dealerId        String
  email           String
  passwordHash    String
  name            String
  role            DealerUserRole  @default(MEMBER)
  
  // Auth state
  emailVerified   Boolean         @default(false)
  verifyToken     String?         // Email verification token
  resetToken      String?         // Password reset token
  resetTokenExp   DateTime?       // Reset token expiration
  
  // Activity tracking
  lastLoginAt     DateTime?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  dealer          Dealer          @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  invitesSent     DealerInvite[]  @relation("InvitedBy")

  @@unique([dealerId, email])
  @@index([email])
  @@index([dealerId])
  @@map("dealer_users")
}

model DealerInvite {
  id              String          @id @default(cuid())
  dealerId        String
  email           String
  role            DealerUserRole  @default(MEMBER)
  inviteToken     String          @unique
  invitedById     String          // DealerUser who sent the invite
  expiresAt       DateTime
  acceptedAt      DateTime?
  createdAt       DateTime        @default(now())

  dealer          Dealer          @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  invitedBy       DealerUser      @relation("InvitedBy", fields: [invitedById], references: [id])

  @@unique([dealerId, email])
  @@index([inviteToken])
  @@index([dealerId])
  @@map("dealer_invites")
}

model DealerFeed {
  id              String        @id @default(cuid())
  dealerId        String
  name            String?       // Optional feed name
  feedType        FeedType
  url             String?
  username        String?       // Encrypted at app layer
  password        String?       // Encrypted at app layer
  scheduleMinutes Int           @default(60)
  status          FeedStatus    @default(PENDING)
  feedHash        String?       // For change detection
  lastSuccessAt   DateTime?
  lastFailureAt   DateTime?
  lastError       String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  dealer          Dealer        @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  runs            DealerFeedRun[]
  skus            DealerSku[]

  @@index([dealerId])
  @@map("dealer_feeds")
}

model DealerFeedRun {
  id              String        @id @default(cuid())
  dealerId        String
  feedId          String
  status          FeedRunStatus
  errors          Json?         // Array of error objects
  rowCount        Int           @default(0)
  processedCount  Int           @default(0)
  matchedCount    Int           @default(0)
  failedCount     Int           @default(0)
  duration        Int?          // milliseconds
  startedAt       DateTime      @default(now())
  completedAt     DateTime?

  feed            DealerFeed    @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@index([feedId])
  @@index([startedAt])
  @@map("dealer_feed_runs")
}

model DealerSku {
  id                String        @id @default(cuid())
  dealerId          String
  feedId            String?
  feedRunId         String?
  
  // Raw data from feed
  rawTitle          String
  rawDescription    String?       @db.Text
  rawPrice          Decimal       @db.Decimal(10, 2)
  rawUpc            String?
  rawSku            String?       // Dealer's internal SKU
  rawCaliber        String?
  rawGrain          String?
  rawCase           String?
  rawBulletType     String?
  rawBrand          String?
  rawPackSize       Int?
  rawInStock        Boolean       @default(true)
  rawUrl            String?
  rawImageUrl       String?
  
  // Mapping to canonical
  canonicalSkuId    String?
  mappingConfidence MappingConfidence @default(NONE)
  needsReview       Boolean       @default(false)
  mappedAt          DateTime?
  mappedBy          String?       // 'auto' or 'manual' or admin ID
  
  // Parsed hints (from regex/AI)
  parsedCaliber     String?
  parsedGrain       Int?
  parsedPackSize    Int?
  parsedBulletType  String?
  parsedBrand       String?
  parseConfidence   Decimal?      @db.Decimal(3, 2)
  
  // For deduplication within dealer
  dealerSkuHash     String?       // Hash of key attributes
  
  isActive          Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  dealer            Dealer        @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  feed              DealerFeed?   @relation(fields: [feedId], references: [id], onDelete: SetNull)
  canonicalSku      CanonicalSku? @relation(fields: [canonicalSkuId], references: [id])
  insights          DealerInsight[]

  @@unique([dealerId, dealerSkuHash])
  @@index([dealerId])
  @@index([feedId])
  @@index([canonicalSkuId])
  @@index([needsReview])
  @@index([isActive])
  @@map("dealer_skus")
}

model CanonicalSku {
  id              String        @id @default(cuid())
  upc             String?       @unique
  caliber         String
  grain           Int
  caseType        String?
  bulletType      String?
  brand           String
  packSize        Int
  name            String        // Canonical display name
  imageUrl        String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  dealerSkus      DealerSku[]
  snapshots       PricingSnapshot[]
  benchmark       Benchmark?

  // Optional link to consumer-facing Product
  productId       String?
  product         Product?      @relation(fields: [productId], references: [id])

  @@index([upc])
  @@index([caliber, grain, brand, packSize])
  @@map("canonical_skus")
}

model PricingSnapshot {
  id              String        @id @default(cuid())
  canonicalSkuId  String
  dealerId        String
  price           Decimal       @db.Decimal(10, 2)
  pricePerRound   Decimal?      @db.Decimal(10, 4)
  packSize        Int
  inStock         Boolean       @default(true)
  createdAt       DateTime      @default(now())

  canonicalSku    CanonicalSku  @relation(fields: [canonicalSkuId], references: [id], onDelete: Cascade)

  @@index([canonicalSkuId])
  @@index([dealerId])
  @@index([createdAt])
  @@map("pricing_snapshots")
}

model Benchmark {
  id              String              @id @default(cuid())
  canonicalSkuId  String              @unique
  medianPrice     Decimal             @db.Decimal(10, 2)
  minPrice        Decimal             @db.Decimal(10, 2)
  maxPrice        Decimal             @db.Decimal(10, 2)
  avgPrice        Decimal?            @db.Decimal(10, 2)
  sellerCount     Int
  source          BenchmarkSource
  confidence      BenchmarkConfidence
  dataPoints      Int                 @default(0)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  canonicalSku    CanonicalSku        @relation(fields: [canonicalSkuId], references: [id], onDelete: Cascade)

  @@map("benchmarks")
}

model DealerInsight {
  id              String            @id @default(cuid())
  dealerId        String
  dealerSkuId     String?
  canonicalSkuId  String?
  type            InsightType
  confidence      InsightConfidence
  title           String
  message         String            @db.Text
  
  // Insight data
  dealerPrice     Decimal?          @db.Decimal(10, 2)
  marketMedian    Decimal?          @db.Decimal(10, 2)
  marketMin       Decimal?          @db.Decimal(10, 2)
  marketMax       Decimal?          @db.Decimal(10, 2)
  sellerCount     Int?
  priceDelta      Decimal?          @db.Decimal(10, 2)
  deltaPercent    Decimal?          @db.Decimal(5, 2)
  
  metadata        Json?             // Additional context
  
  // Status
  isActive        Boolean           @default(true)
  dismissedAt     DateTime?
  dismissedUntil  DateTime?
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  dealer          Dealer            @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  dealerSku       DealerSku?        @relation(fields: [dealerSkuId], references: [id], onDelete: SetNull)

  @@index([dealerId])
  @@index([type])
  @@index([isActive])
  @@map("dealer_insights")
}

model PixelEvent {
  id              String        @id @default(cuid())
  dealerId        String
  orderId         String
  orderValue      Decimal       @db.Decimal(10, 2)
  orderCurrency   String        @default("USD")
  skuList         Json?         // Array of { sku, qty, price }
  
  // Attribution
  clickEventId    String?       // Link to originating click
  attributedAt    DateTime?
  
  // Request metadata
  userAgent       String?
  ipHash          String?       // Hashed for privacy
  referrer        String?
  
  createdAt       DateTime      @default(now())

  dealer          Dealer        @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@index([orderId])
  @@index([createdAt])
  @@map("pixel_events")
}

model ClickEvent {
  id              String        @id @default(cuid())
  dealerId        String
  dealerSkuId     String?
  canonicalSkuId  String?
  
  // Session tracking
  sessionId       String?
  
  // Request metadata
  userAgent       String?
  ipHash          String?
  referrer        String?
  
  createdAt       DateTime      @default(now())

  dealer          Dealer        @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@index([dealerSkuId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("click_events")
}

model DealerNotificationPref {
  id                  String        @id @default(cuid())
  dealerId            String        @unique
  
  fatalFeedErrors     Boolean       @default(true)
  nonFatalFeedIssues  Boolean       @default(false)
  successfulUpdates   Boolean       @default(false)
  weeklyPulse         Boolean       @default(true)
  insightAlerts       Boolean       @default(true)
  
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  dealer              Dealer        @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@map("dealer_notification_prefs")
}

model AdminAuditLog {
  id              String        @id @default(cuid())
  adminUserId     String        // Reference to User.id (admin)
  dealerId        String?       // Target dealer if applicable
  action          String        // e.g., 'impersonate', 'suspend', 'approve'
  resource        String?       // e.g., 'dealer', 'feed', 'sku'
  resourceId      String?
  oldValue        Json?
  newValue        Json?
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime      @default(now())

  @@index([adminUserId])
  @@index([dealerId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

// =============================================
// DEALER PORTAL ENUMS
// =============================================

enum DealerStatus {
  PENDING           // Awaiting admin approval
  ACTIVE            // Approved and operational
  SUSPENDED         // Admin suspended
}

enum DealerTier {
  FOUNDING          // Free 12-month program
  BASIC             // Free limited features (post-founding)
  PRO               // Paid full features
  ENTERPRISE        // Custom pricing
}

enum DealerUserRole {
  OWNER             // Original account creator, full access, cannot be removed
  ADMIN             // Can manage team, settings, full access
  MEMBER            // Standard access to dashboard, SKUs, insights
  VIEWER            // Read-only access
}

enum StoreType {
  ONLINE_ONLY
  RETAIL_AND_ONLINE
}

enum ShippingType {
  FLAT              // Flat rate shipping
  PER_UNIT          // Per-unit/per-round shipping
  CALCULATED        // Calculated at checkout (unknown)
  FREE              // Free shipping
  UNKNOWN
}

enum FeedType {
  URL               // Public HTTP/HTTPS
  AUTH_URL          // Basic Auth URL
  FTP               // FTP
  SFTP              // SFTP
  UPLOAD            // Manual CSV upload
}

enum FeedStatus {
  PENDING           // Not yet run
  HEALTHY           // Last run successful
  WARNING           // Last run had non-fatal issues
  FAILED            // Last run failed
}

enum FeedRunStatus {
  RUNNING
  SUCCESS
  WARNING
  FAILURE
}

enum MappingConfidence {
  HIGH              // UPC + Brand + Pack match
  MEDIUM            // Attribute match without UPC
  LOW               // Partial match, flagged for review
  NONE              // Cannot map
}

enum BenchmarkSource {
  INTERNAL          // IronScout dealer data only
  EXTERNAL          // External market data (future)
  MIXED             // Combination of both
}

enum BenchmarkConfidence {
  HIGH              // â‰¥3 dealers, fresh data, no outliers
  MEDIUM            // Limited data or slight staleness
  NONE              // Insufficient data
}

enum InsightType {
  OVERPRICED        // Dealer price above market
  UNDERPRICED       // Dealer price below market (opportunity)
  STOCK_OPPORTUNITY // High demand, dealer OOS
  ATTRIBUTE_GAP     // Missing data preventing benchmarks
}

enum InsightConfidence {
  HIGH
  MEDIUM
}

// =============================================
// NextAuth.js required models
// =============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
