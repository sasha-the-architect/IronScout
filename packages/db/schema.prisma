generator client {
  provider        = "prisma-client-js"
  output          = "./generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector]
}

model User {
  id                   String                @id @default(cuid())
  email                String                @unique
  name                 String?
  image                String?
  password             String?
  emailVerified        DateTime?
  tier                 UserTier              @default(FREE)
  status               UserStatus            @default(ACTIVE)
  deletionRequestedAt  DateTime?
  deletionScheduledFor DateTime?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  accounts             Account[]
  sessions             Session[]
  alerts               Alert[]
  dataSubscriptions    DataSubscription[]
  reports              ProductReport[]
  subscriptions        Subscription[]
  watchlistItems       WatchlistItem[]
  watchlistCollections WatchlistCollection[]

  @@map("users")
}

// ============================================================================
// SAVED ITEMS (ADR-011: Unified Watchlist + Alerts)
// WatchlistItem = Saved Item preferences row
// Alert records are declarative rule markers; all prefs/state live here
// ============================================================================

model WatchlistItem {
  id        String @id @default(cuid())
  userId    String
  productId String

  // Notification preferences (ADR-011 Phase 2)
  notificationsEnabled Boolean @default(true)
  priceDropEnabled     Boolean @default(true)
  backInStockEnabled   Boolean @default(true)

  // Anti-spam thresholds
  minDropPercent Int     @default(5) // 0-100
  minDropAmount  Decimal @default(5.0) @db.Decimal(10, 2)

  // Cooldowns
  stockAlertCooldownHours Int       @default(24) // >= 1
  lastStockNotifiedAt     DateTime?
  lastPriceNotifiedAt     DateTime?

  // Legacy field (deprecated, kept for migration)
  collectionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  product    Product              @relation(fields: [productId], references: [id], onDelete: Cascade)
  collection WatchlistCollection? @relation(fields: [collectionId], references: [id], onDelete: SetNull)
  alerts     Alert[]

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@index([collectionId])
  @@map("watchlist_items")
}

model WatchlistCollection {
  id        String          @id @default(cuid())
  userId    String
  name      String
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     WatchlistItem[]

  @@index([userId])
  @@map("watchlist_collections")
}

model Product {
  id                    String                 @id @default(cuid())
  name                  String
  description           String?
  category              String
  brand                 String?
  imageUrl              String?
  upc                   String?                @unique
  caliber               String?
  grainWeight           Int?
  caseMaterial          String?
  purpose               String?
  roundCount            Int?
  metadata              Json?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  embedding             Unsupported("vector")?
  barrelLengthReference Decimal?               @db.Decimal(4, 2)
  bulletType            BulletType?
  controlledExpansion   Boolean?
  dataConfidence        Decimal?               @db.Decimal(3, 2)
  dataSource            DataSource?            @default(UNKNOWN)
  factoryNew            Boolean?               @default(true)
  isSubsonic            Boolean?
  lowFlash              Boolean?
  lowRecoil             Boolean?
  matchGrade            Boolean?
  muzzleVelocityFps     Int?
  pressureRating        PressureRating?        @default(STANDARD)
  shortBarrelOptimized  Boolean?
  suppressorSafe        Boolean?
  alerts                Alert[]
  canonicalSkus         CanonicalSku[]
  prices                Price[]
  reports               ProductReport[]
  watchlistItems        WatchlistItem[]

  @@index([caliber])
  @@index([bulletType])
  @@index([pressureRating])
  @@index([isSubsonic])
  @@index([purpose])
  @@map("products")
}

model Retailer {
  id            String         @id @default(cuid())
  name          String
  website       String         @unique
  logoUrl       String?
  tier          RetailerTier   @default(STANDARD)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  dealer        Dealer?
  prices        Price[]
  subscriptions Subscription[]
  sources       Source[]

  @@map("retailers")
}

// ═══════════════════════════════════════════════════════════════════════════
// ⚠️ PLATFORM INVARIANT: The `prices` table must NEVER gain additional unique
// constraints. Doing so will silently drop inserts due to ON CONFLICT DO NOTHING
// in affiliate feed ingest. This is enforced via migration test.
// ═══════════════════════════════════════════════════════════════════════════
model Price {
  id                  String          @id @default(cuid())
  productId           String?         // Nullable for v1 affiliate prices (use sourceProductId instead)
  retailerId          String
  price               Decimal         @db.Decimal(10, 2)
  currency            String          @default("USD")
  url                 String
  inStock             Boolean         @default(true)
  createdAt           DateTime        @default(now())
  freeShippingMinimum Decimal?        @db.Decimal(10, 2)
  shippingCost        Decimal?        @db.Decimal(10, 2)
  shippingNotes       String?
  product             Product?        @relation(fields: [productId], references: [id], onDelete: Cascade)
  retailer            Retailer        @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  reports             ProductReport[]

  // Sale/promo metadata (persisted with snapshot per ADR-004)
  originalPrice Decimal?   @db.Decimal(10, 2) // MSRP when feed provides it
  priceType     PriceType? // Regular, sale, or clearance pricing
  saleStartsAt  DateTime? // Informational only, not enforced
  saleEndsAt    DateTime? // Informational only, not enforced

  // Link to SourceProduct for affiliate prices
  sourceProductId String?
  sourceProduct   SourceProduct? @relation(fields: [sourceProductId], references: [id])

  // Affiliate price deduplication (nullable - only set for affiliate pipeline)
  affiliateFeedRunId String?           // Run that created this price
  priceSignatureHash String?           // SHA-256 of (amount|currency|promoJson) for dedupe
  affiliateFeedRun   AffiliateFeedRun? @relation(fields: [affiliateFeedRunId], references: [id], onDelete: SetNull)

  // Partial unique index for affiliate dedupe - see migration SQL
  // Ensures at most one price per (sourceProductId, runId, signature) for retry safety

  @@index([productId])
  @@index([retailerId])
  @@index([inStock])
  @@index([sourceProductId])
  @@map("prices")
}

// Alert = Declarative rule marker (ADR-011)
// Answers only: "Does this user want this rule type for this item?"
// All preferences and state live on WatchlistItem
model Alert {
  id              String        @id @default(cuid())
  userId          String
  productId       String
  watchlistItemId String
  ruleType        AlertRuleType
  isEnabled       Boolean       @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  watchlistItem WatchlistItem @relation(fields: [watchlistItemId], references: [id], onDelete: Cascade)

  @@unique([userId, productId, ruleType])
  @@index([userId])
  @@index([productId])
  @@index([watchlistItemId])
  @@map("alerts")
}

model Advertisement {
  id          String   @id @default(cuid())
  title       String
  description String
  imageUrl    String?
  targetUrl   String
  adType      AdType   @default(DISPLAY)
  isActive    Boolean  @default(true)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("advertisements")
}

model ProductReport {
  id          String           @id @default(cuid())
  productId   String
  userId      String?
  priceId     String?
  issueType   ProductIssueType
  description String
  status      ReportStatus     @default(PENDING)
  reviewedBy  String?
  reviewNotes String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  resolvedAt  DateTime?
  price       Price?           @relation(fields: [priceId], references: [id])
  product     Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  user        User?            @relation(fields: [userId], references: [id])

  @@map("product_reports")
}

model Source {
  id               String            @id @default(cuid())
  name             String
  url              String
  type             SourceType        @default(HTML)
  enabled          Boolean           @default(true)
  interval         Int               @default(3600)
  lastRunAt        DateTime?
  paginationConfig Json?
  feedHash         String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  executions       Execution[]

  // Required FK - all sources belong to a retailer
  retailer   Retailer @relation(fields: [retailerId], references: [id])
  retailerId String

  // Display and kind
  isDisplayPrimary Boolean    @default(false) // For multi-source retailer display
  sourceKind       SourceKind @default(DIRECT)

  // Affiliate metadata for v1 traceability
  affiliateNetwork     AffiliateNetwork? // IMPACT only in v1
  affiliateAccountId   String?           // e.g., Impact advertiser/partner ID
  affiliateAccountName String?           // Copy for debugging/display

  // Affiliate configuration (for tracking URL generation at click time)
  affiliateProgramId        String? // Internal program identifier for this Source, if used
  affiliateAdvertiserId     String? // Network advertiser/merchant ID (Impact advertiser ID or equivalent)
  affiliateCampaignId       String? // Campaign identifier for attribution within the network
  affiliateTrackingTemplate String? @db.Text // URL template for generating tracking links at click time

  // Relations
  affiliateFeed  AffiliateFeed?
  sourceProducts SourceProduct[]

  @@index([retailerId], map: "sources_retailer_id_idx")
  @@map("sources")
}

model Execution {
  id            String          @id @default(cuid())
  sourceId      String
  status        ExecutionStatus @default(PENDING)
  startedAt     DateTime        @default(now())
  completedAt   DateTime?
  duration      Int?
  itemsFound    Int             @default(0)
  itemsUpserted Int             @default(0)
  errorMessage  String?
  logs          ExecutionLog[]
  source        Source          @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@map("executions")
}

model ExecutionLog {
  id          String    @id @default(cuid())
  executionId String
  level       LogLevel  @default(INFO)
  event       String
  message     String
  metadata    Json?
  timestamp   DateTime  @default(now())
  execution   Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@index([level])
  @@index([event])
  @@map("execution_logs")
}

// ============================================================================
// AFFILIATE FEED SYSTEM
// ============================================================================

model AffiliateFeed {
  id       String   @id @default(cuid())
  source   Source   @relation(fields: [sourceId], references: [id])
  sourceId String   @unique

  network AffiliateNetwork
  status  AffiliateFeedStatus @default(DRAFT)

  // Scheduling
  scheduleFrequencyHours Int?      // null = manual only
  nextRunAt              DateTime? // null = not scheduled, set by scheduler
  expiryHours            Int       @default(48) // Valid range: 1-168
  consecutiveFailures    Int       @default(0)
  lastRunAt              DateTime? // for UI display only
  manualRunPending       Boolean   @default(false)

  // Transport
  transport FeedTransport @default(SFTP)
  host      String?
  port      Int?
  path      String? // Fixed path, e.g., /feeds/catalog.csv.gz
  username  String?

  // Encrypted credentials (AES-256-GCM)
  secretCiphertext Bytes?
  secretKeyId      String? // For future KMS migration
  secretVersion    Int     @default(1)

  // Format
  format      FeedFormat      @default(CSV)
  compression FeedCompression @default(NONE)

  // Change detection
  lastRemoteMtime DateTime?
  lastRemoteSize  BigInt?
  lastContentHash String?

  // Safety limits
  maxFileSizeBytes BigInt? // null = use default (500 MB)
  maxRowCount      Int?    // null = use default (500,000)

  // Advisory lock key (for PostgreSQL advisory locks)
  feedLockId BigInt @default(autoincrement()) @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  // Admin who created this feed

  runs AffiliateFeedRun[]

  @@index([status])
  @@index([nextRunAt])
  @@map("affiliate_feeds")
}

model AffiliateFeedRun {
  id       String @id @default(cuid())
  feed     AffiliateFeed @relation(fields: [feedId], references: [id], onDelete: Cascade)
  feedId   String
  sourceId String // Denormalized for query convenience

  trigger   AffiliateFeedRunTrigger @default(SCHEDULED)
  status    AffiliateFeedRunStatus  @default(RUNNING)
  startedAt DateTime                @default(now())
  finishedAt DateTime?
  durationMs Int?

  // Metrics (null = not reached stage)
  downloadBytes    BigInt?
  rowsRead         Int?
  rowsParsed       Int?
  productsUpserted Int? // SourceProducts created/updated (Phase 1)
  pricesWritten    Int? // Actual Price rows inserted (from DB rowCount)
  productsPromoted Int? // Products with lastSeenSuccessAt updated (Phase 2, from DB rowCount)
  errorCount       Int?

  // Expiry metrics (post-circuit-breaker promotion)
  productsExpired      Int? // lastSeenSuccessAt updated >= expiryHours ago
  productsRejected     Int? // Failed validation/parsing
  duplicateKeyCount    Int? // Same identity seen multiple times
  urlHashFallbackCount Int? // URL_HASH used (no SKU/UPC)

  // Circuit breaker metrics (computed pre-promotion)
  activeCountBefore Int? // Count of active products before this run
  seenSuccessCount  Int? // Products that would be marked "seen success"
  wouldExpireCount  Int? // Products that WOULD be expired (before circuit breaker)

  // Skip detection
  skippedReason String? // e.g., "UNCHANGED_HASH", "UNCHANGED_MTIME"

  // Failure classification (for retry decisions and UI display)
  failureKind    String? // 'TRANSIENT' | 'PERMANENT' | 'CONFIG'
  failureCode    String? // Error code (e.g., 'AUTH_FAILED', 'FILE_NOT_FOUND')
  failureMessage String? // Human-readable error message

  // Flags
  isPartial        Boolean @default(false) // Derived: errorCount > 0 && productsUpserted > 0
  expiryStepFailed Boolean @default(false)

  // Expiry circuit breaker
  // Semantics: expiryBlocked=true means "promotion was blocked by circuit breaker"
  // It stays true even after approval. expiryApprovedAt IS NOT NULL is the approval signal.
  expiryBlocked       Boolean   @default(false)
  expiryBlockedReason String?   // 'SPIKE_THRESHOLD_EXCEEDED' | 'DATA_QUALITY_URL_HASH_SPIKE'
  expiryApprovedAt    DateTime? // Non-null = admin approved and promotion succeeded
  expiryApprovedBy    String?

  // Artifact (future)
  artifactUrl String?

  errors       AffiliateFeedRunError[]
  seenProducts SourceProductSeen[]
  prices       Price[]

  @@index([feedId, startedAt])
  @@index([feedId, trigger, startedAt])
  @@index([feedId, status, startedAt])
  @@map("affiliate_feed_runs")
}

model AffiliateFeedRunError {
  id    String @id @default(cuid())
  run   AffiliateFeedRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  runId String

  code      String  // ERROR_CODE enum value
  message   String
  rowNumber Int?    // If row-specific
  sample    Json?   // Sample data for debugging

  createdAt DateTime @default(now())

  @@index([runId])
  @@map("affiliate_feed_run_errors")
}

model SourceProduct {
  id       String @id @default(cuid())
  source   Source @relation(fields: [sourceId], references: [id])
  sourceId String

  // Identity (one of these is the resolved key)
  identityType  SourceProductIdentityType
  identityValue String // The actual SKU, UPC, IMPACT_ITEM_ID, or URL hash

  // Product display fields (required per spec Section 2.3)
  title    String
  url      String
  imageUrl String?

  // Secondary identifiers (stored but not used as key)
  sku           String?
  upc           String?
  urlHash       String? // SHA-256 of normalized URL
  normalizedUrl String?
  impactItemId  String? // Impact network's unique item identifier

  // Run attribution
  createdByRunId     String?
  lastUpdatedByRunId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  presence   SourceProductPresence?
  seenInRuns SourceProductSeen[]
  prices     Price[]

  @@unique([sourceId, identityType, identityValue])
  @@index([sourceId])
  @@index([impactItemId])
  @@index([sku])
  @@map("source_products")
}

model SourceProductPresence {
  id              String        @id @default(cuid())
  sourceProduct   SourceProduct @relation(fields: [sourceProductId], references: [id], onDelete: Cascade)
  sourceProductId String        @unique

  lastSeenAt        DateTime  // Updated on every observation (Phase 1)
  lastSeenSuccessAt DateTime? // Updated only after circuit breaker passes (Phase 2)

  updatedAt DateTime @updatedAt

  @@index([lastSeenSuccessAt])
  @@map("source_product_presence")
}

model SourceProductSeen {
  id              String   @id @default(cuid())
  runId           String
  sourceProductId String
  createdAt       DateTime @default(now())

  run           AffiliateFeedRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  sourceProduct SourceProduct    @relation(fields: [sourceProductId], references: [id], onDelete: Cascade)

  @@unique([runId, sourceProductId])
  @@index([runId])
  @@map("source_product_seen")
}

model Subscription {
  id         String             @id @default(cuid())
  userId     String?
  retailerId String?
  type       SubscriptionType
  status     SubscriptionStatus @default(ACTIVE)
  startDate  DateTime           @default(now())
  endDate    DateTime?
  amount     Decimal            @db.Decimal(10, 2)
  currency   String             @default("USD")
  stripeId   String?            @unique
  retailer   Retailer?          @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  user       User?              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model DataSubscription {
  id        String             @id @default(cuid())
  userId    String
  plan      DaaSPlan           @default(BASIC)
  status    SubscriptionStatus @default(ACTIVE)
  apiKey    String             @unique
  rateLimit Int                @default(1000)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("data_subscriptions")
}

model MarketReport {
  id          String   @id @default(cuid())
  productId   String?
  category    String
  reportType  String
  data        Json
  generatedAt DateTime @default(now())

  @@map("market_reports")
}

model Dealer {
  id                       String                   @id @default(cuid())
  businessName             String
  websiteUrl               String
  phone                    String?
  storeType                StoreType                @default(ONLINE_ONLY)
  status                   DealerStatus             @default(PENDING)
  tier                     DealerTier               @default(FOUNDING)
  pixelApiKey              String?                  @unique
  pixelEnabled             Boolean                  @default(false)
  shippingType             ShippingType             @default(UNKNOWN)
  shippingFlat             Decimal?                 @db.Decimal(10, 2)
  shippingPerUnit          Decimal?                 @db.Decimal(10, 2)
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  retailerId               String?                  @unique
  contactFirstName         String
  contactLastName          String
  lastSubscriptionNotifyAt DateTime?
  subscriptionExpiresAt    DateTime?
  subscriptionGraceDays    Int                      @default(7)
  subscriptionStatus       DealerSubscriptionStatus @default(ACTIVE)
  autoRenew                Boolean                  @default(true)
  paymentMethod            DealerPaymentMethod?
  stripeCustomerId         String?                  @unique
  stripeSubscriptionId     String?                  @unique
  clickEvents              ClickEvent[]
  contacts                 DealerContact[]
  feeds                    DealerFeed[]
  insights                 DealerInsight[]
  invites                  DealerInvite[]
  notificationPref         DealerNotificationPref?
  skus                     DealerSku[]
  users                    DealerUser[]
  retailer                 Retailer?                @relation(fields: [retailerId], references: [id])
  pixelEvents              PixelEvent[]

  @@map("dealers")
}

model DealerUser {
  id            String         @id @default(cuid())
  dealerId      String
  email         String
  passwordHash  String
  name          String
  role          DealerUserRole @default(MEMBER)
  emailVerified Boolean        @default(false)
  verifyToken   String?
  resetToken    String?
  resetTokenExp DateTime?
  lastLoginAt   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  invitesSent   DealerInvite[] @relation("InvitedBy")
  dealer        Dealer         @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@unique([dealerId, email])
  @@index([email])
  @@index([dealerId])
  @@map("dealer_users")
}

model DealerInvite {
  id          String         @id @default(cuid())
  dealerId    String
  email       String
  role        DealerUserRole @default(MEMBER)
  inviteToken String         @unique
  invitedById String
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime       @default(now())
  dealer      Dealer         @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  invitedBy   DealerUser     @relation("InvitedBy", fields: [invitedById], references: [id])

  @@unique([dealerId, email])
  @@index([inviteToken])
  @@index([dealerId])
  @@map("dealer_invites")
}

model DealerContact {
  id                 String              @id @default(cuid())
  dealerId           String
  firstName          String
  lastName           String
  email              String
  phone              String?
  marketingOptIn     Boolean             @default(false)
  communicationOptIn Boolean             @default(true)
  isAccountOwner     Boolean             @default(false)
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  roles              DealerContactRole[] @default([])
  dealer             Dealer              @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@unique([dealerId, email])
  @@index([dealerId])
  @@index([email])
  @@map("dealer_contacts")
}

model DealerFeed {
  id               String              @id @default(cuid())
  dealerId         String
  name             String?
  url              String?
  username         String?
  password         String?
  scheduleMinutes  Int                 @default(60)
  status           FeedStatus          @default(PENDING)
  feedHash         String?
  lastSuccessAt    DateTime?
  lastFailureAt    DateTime?
  lastError        String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  accessType       FeedAccessType      @default(URL)
  enabled          Boolean             @default(true)
  formatType       FeedFormatType      @default(GENERIC)
  lastRunAt        DateTime?
  primaryErrorCode String?
  runs             DealerFeedRun[]
  testRuns         DealerFeedTestRun[]
  dealer           Dealer              @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  skus             DealerSku[]
  corrections      FeedCorrection[]
  quarantined      QuarantinedRecord[]

  @@index([dealerId])
  @@index([enabled])
  @@map("dealer_feeds")
}

model DealerFeedRun {
  id               String        @id @default(cuid())
  dealerId         String
  feedId           String
  status           FeedRunStatus
  errors           Json?
  rowCount         Int           @default(0)
  duration         Int?
  startedAt        DateTime      @default(now())
  completedAt      DateTime?
  primaryErrorCode String?
  quarantinedCount Int           @default(0)
  coercionCount    Int           @default(0)
  errorCodes       Json?
  indexedCount     Int           @default(0)
  rejectedCount    Int           @default(0)
  matchedCount     Int           @default(0)
  feed             DealerFeed    @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@index([feedId])
  @@index([startedAt])
  @@map("dealer_feed_runs")
}

model DealerFeedTestRun {
  id               String        @id @default(cuid())
  dealerId         String
  feedId           String
  sampleSize       Int           @default(50)
  status           TestRunStatus
  recordsParsed    Int           @default(0)
  wouldIndex       Int           @default(0)
  wouldQuarantine  Int           @default(0)
  wouldReject      Int           @default(0)
  warningCount     Int           @default(0)
  errorCount       Int           @default(0)
  primaryErrorCode String?
  errorSamples     Json?
  coercionSummary  Json?
  duration         Int?
  startedAt        DateTime      @default(now())
  completedAt      DateTime?
  feed             DealerFeed    @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@index([feedId])
  @@index([startedAt])
  @@map("dealer_feed_test_runs")
}

model QuarantinedRecord {
  id             String           @id @default(cuid())
  dealerId       String
  feedId         String
  runId          String?
  productType    String?
  matchKey       String
  rawData        Json
  parsedFields   Json?
  blockingErrors Json
  status         QuarantineStatus @default(QUARANTINED)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  corrections    FeedCorrection[]
  feed           DealerFeed       @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@unique([feedId, matchKey])
  @@index([dealerId])
  @@index([feedId, status])
  @@index([status])
  @@map("quarantined_records")
}

model FeedCorrection {
  id                  String             @id @default(cuid())
  dealerId            String
  feedId              String
  quarantinedRecordId String?
  recordRef           String
  field               String
  oldValue            String?
  newValue            String
  createdBy           String
  createdAt           DateTime           @default(now())
  feed                DealerFeed         @relation(fields: [feedId], references: [id], onDelete: Cascade)
  quarantinedRecord   QuarantinedRecord? @relation(fields: [quarantinedRecordId], references: [id])

  @@index([dealerId])
  @@index([feedId, recordRef])
  @@index([quarantinedRecordId])
  @@map("feed_corrections")
}

model DealerSku {
  id                String            @id @default(cuid())
  dealerId          String
  feedId            String?
  feedRunId         String?
  rawTitle          String
  rawDescription    String?
  rawPrice          Decimal           @db.Decimal(10, 2)
  rawUpc            String?
  rawSku            String?
  rawCaliber        String?
  rawGrain          String?
  rawCase           String?
  rawBulletType     String?
  rawBrand          String?
  rawPackSize       Int?
  rawInStock        Boolean           @default(true)
  rawUrl            String?
  rawImageUrl       String?
  canonicalSkuId    String?
  mappingConfidence MappingConfidence @default(NONE)
  needsReview       Boolean           @default(false)
  mappedAt          DateTime?
  mappedBy          String?
  parsedCaliber     String?
  parsedGrain       Int?
  parsedPackSize    Int?
  parsedBulletType  String?
  parsedBrand       String?
  parseConfidence   Decimal?          @db.Decimal(3, 2)
  dealerSkuHash     String?
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  lastSeenAt        DateTime?
  missingCount      Int               @default(0)
  productType       String?
  coercionsApplied  Json?
  insights          DealerInsight[]
  canonicalSku      CanonicalSku?     @relation(fields: [canonicalSkuId], references: [id])
  dealer            Dealer            @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  feed              DealerFeed?       @relation(fields: [feedId], references: [id])

  @@unique([dealerId, dealerSkuHash])
  @@index([dealerId])
  @@index([feedId])
  @@index([canonicalSkuId])
  @@index([needsReview])
  @@index([isActive])
  @@map("dealer_skus")
}

model CanonicalSku {
  id         String            @id @default(cuid())
  upc        String?           @unique
  caliber    String
  grain      Int
  caseType   String?
  bulletType String?
  brand      String
  packSize   Int
  name       String
  imageUrl   String?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  productId  String?
  benchmark  Benchmark?
  product    Product?          @relation(fields: [productId], references: [id])
  dealerSkus DealerSku[]
  snapshots  PricingSnapshot[]

  @@index([upc])
  @@index([caliber, grain, brand, packSize])
  @@map("canonical_skus")
}

model PricingSnapshot {
  id             String       @id @default(cuid())
  canonicalSkuId String
  dealerId       String
  price          Decimal      @db.Decimal(10, 2)
  pricePerRound  Decimal?     @db.Decimal(10, 4)
  packSize       Int
  inStock        Boolean      @default(true)
  createdAt      DateTime     @default(now())
  canonicalSku   CanonicalSku @relation(fields: [canonicalSkuId], references: [id], onDelete: Cascade)

  @@index([canonicalSkuId])
  @@index([dealerId])
  @@index([createdAt])
  @@map("pricing_snapshots")
}

model Benchmark {
  id             String              @id @default(cuid())
  canonicalSkuId String              @unique
  medianPrice    Decimal             @db.Decimal(10, 2)
  minPrice       Decimal             @db.Decimal(10, 2)
  maxPrice       Decimal             @db.Decimal(10, 2)
  avgPrice       Decimal?            @db.Decimal(10, 2)
  sellerCount    Int
  source         BenchmarkSource
  confidence     BenchmarkConfidence
  dataPoints     Int                 @default(0)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  canonicalSku   CanonicalSku        @relation(fields: [canonicalSkuId], references: [id], onDelete: Cascade)

  @@map("benchmarks")
}

model DealerInsight {
  id             String            @id @default(cuid())
  dealerId       String
  dealerSkuId    String?
  canonicalSkuId String?
  type           InsightType
  confidence     InsightConfidence
  title          String
  message        String
  dealerPrice    Decimal?          @db.Decimal(10, 2)
  marketMedian   Decimal?          @db.Decimal(10, 2)
  marketMin      Decimal?          @db.Decimal(10, 2)
  marketMax      Decimal?          @db.Decimal(10, 2)
  sellerCount    Int?
  priceDelta     Decimal?          @db.Decimal(10, 2)
  deltaPercent   Decimal?          @db.Decimal(5, 2)
  metadata       Json?
  isActive       Boolean           @default(true)
  dismissedAt    DateTime?
  dismissedUntil DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  dealer         Dealer            @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  dealerSku      DealerSku?        @relation(fields: [dealerSkuId], references: [id])

  @@index([dealerId])
  @@index([type])
  @@index([isActive])
  @@map("dealer_insights")
}

model PixelEvent {
  id            String    @id @default(cuid())
  dealerId      String
  orderId       String
  orderValue    Decimal   @db.Decimal(10, 2)
  orderCurrency String    @default("USD")
  skuList       Json?
  clickEventId  String?
  attributedAt  DateTime?
  userAgent     String?
  ipHash        String?
  referrer      String?
  createdAt     DateTime  @default(now())
  dealer        Dealer    @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@index([orderId])
  @@index([createdAt])
  @@map("pixel_events")
}

model ClickEvent {
  id             String   @id @default(cuid())
  dealerId       String
  dealerSkuId    String?
  canonicalSkuId String?
  sessionId      String?
  userAgent      String?
  ipHash         String?
  referrer       String?
  createdAt      DateTime @default(now())
  dealer         Dealer   @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@index([dealerSkuId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("click_events")
}

model DealerNotificationPref {
  id                 String   @id @default(cuid())
  dealerId           String   @unique
  fatalFeedErrors    Boolean  @default(true)
  nonFatalFeedIssues Boolean  @default(false)
  successfulUpdates  Boolean  @default(false)
  weeklyPulse        Boolean  @default(true)
  insightAlerts      Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  dealer             Dealer   @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@map("dealer_notification_prefs")
}

model AdminAuditLog {
  id          String   @id @default(cuid())
  adminUserId String
  dealerId    String?
  action      String
  resource    String?
  resourceId  String?
  oldValue    Json?
  newValue    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([adminUserId])
  @@index([dealerId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserTier {
  FREE
  PREMIUM
}

enum UserStatus {
  ACTIVE
  PENDING_DELETION
  DELETED
}

enum RetailerTier {
  STANDARD
  PREMIUM
}

enum PriceType {
  REGULAR
  SALE
  CLEARANCE
}

enum AlertRuleType {
  PRICE_DROP
  BACK_IN_STOCK
}

enum AdType {
  DISPLAY
  SPONSORED_PRODUCT
  BANNER
}

enum SubscriptionType {
  USER_PREMIUM
  RETAILER_PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

enum ExecutionStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

enum LogLevel {
  INFO
  WARN
  ERROR
}

enum SourceType {
  HTML
  JS_RENDERED
  RSS
  JSON
  FEED_CSV
  FEED_XML
  FEED_JSON
}

// v1 only supports Impact network
// Additional networks (AvantLink, ShareASale, CJ, Rakuten) are post-v1
enum AffiliateNetwork {
  IMPACT
}

enum ProductIssueType {
  INCORRECT_PRICE
  OUT_OF_STOCK
  INCORRECT_INFO
  BROKEN_LINK
  WRONG_PRODUCT
  SPAM
  OTHER
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

enum DaaSPlan {
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum BulletType {
  JHP
  HP
  BJHP
  XTP
  HST
  GDHP
  VMAX
  FMJ
  TMJ
  CMJ
  MC
  BALL
  SP
  JSP
  PSP
  RN
  FPRN
  FRANGIBLE
  AP
  TRACER
  BLANK
  WADCUTTER
  SWC
  LSWC
  BUCKSHOT
  BIRDSHOT
  SLUG
  OTHER
}

enum PressureRating {
  STANDARD
  PLUS_P
  PLUS_P_PLUS
  NATO
  UNKNOWN
}

enum DataSource {
  MANUFACTURER
  RETAILER_FEED
  PARSED
  MANUAL
  AI_INFERRED
  UNKNOWN
}

enum DealerStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum DealerTier {
  FOUNDING
  BASIC
  PRO
  ENTERPRISE
}

enum DealerSubscriptionStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
  CANCELLED
}

enum DealerPaymentMethod {
  STRIPE
  PURCHASE_ORDER
}

enum DealerUserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum DealerContactRole {
  PRIMARY
  BILLING
  TECHNICAL
  MARKETING
  OTHER
}

enum StoreType {
  ONLINE_ONLY
  RETAIL_AND_ONLINE
}

enum ShippingType {
  FLAT
  PER_UNIT
  CALCULATED
  FREE
  UNKNOWN
}

enum FeedAccessType {
  URL
  AUTH_URL
  FTP
  SFTP
  UPLOAD
}

enum FeedFormatType {
  GENERIC
  AMMOSEEK_V1
  GUNENGINE_V2
  IMPACT
}

enum QuarantineStatus {
  QUARANTINED
  RESOLVED
  DISMISSED
}

enum TestRunStatus {
  PASS
  WARN
  FAIL
}

enum FeedStatus {
  PENDING
  HEALTHY
  WARNING
  FAILED
}

enum FeedRunStatus {
  RUNNING
  SUCCESS
  WARNING
  FAILURE
  PENDING
  SKIPPED
}

enum MappingConfidence {
  HIGH
  MEDIUM
  LOW
  NONE
}

enum BenchmarkSource {
  INTERNAL
  EXTERNAL
  MIXED
}

enum BenchmarkConfidence {
  HIGH
  MEDIUM
  NONE
}

enum InsightType {
  OVERPRICED
  UNDERPRICED
  STOCK_OPPORTUNITY
  ATTRIBUTE_GAP
}

enum InsightConfidence {
  HIGH
  MEDIUM
}

// ============================================================================
// AFFILIATE FEED ENUMS
// ============================================================================

enum SourceKind {
  DIRECT        // Direct retailer integration
  AFFILIATE_FEED // Affiliate network feed
  OTHER
}

enum AffiliateFeedStatus {
  DRAFT     // Not yet configured/validated
  ENABLED   // Scheduled or manual runs allowed
  PAUSED    // Manually paused by admin
  DISABLED  // Auto-paused after failures
}

enum FeedTransport {
  FTP
  SFTP
}

// v1 only supports CSV. TSV/XML/JSON are post-v1.
enum FeedFormat {
  CSV
}

enum FeedCompression {
  NONE
  GZIP
}

// Per spec Q8.2.3: No SKIPPED status - use SUCCEEDED + skippedReason instead
enum AffiliateFeedRunStatus {
  RUNNING
  SUCCEEDED
  FAILED
}

enum AffiliateFeedRunTrigger {
  SCHEDULED
  MANUAL
  MANUAL_PENDING  // Follow-up run from manualRunPending flag
  ADMIN_TEST      // Test run from admin UI (if test runs create records)
  RETRY
}

// Per spec: Identity priority is IMPACT_ITEM_ID > SKU > URL_HASH
// UPC is stored on SourceProduct for reference but not used for identity in v1
enum SourceProductIdentityType {
  IMPACT_ITEM_ID // Impact network's unique item identifier (highest priority)
  SKU            // Merchant/source-specific SKU
  URL_HASH       // SHA-256 of normalized URL (fallback)
}
