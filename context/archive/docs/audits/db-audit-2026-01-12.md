# IronScout Database Audit Report

**Generated:** 2026-01-12
**Database Size:** 80.06 MB
**Total Tables:** 50
**Total Columns:** 654
**Total Indexes:** 210
**Total FK Constraints:** 60

---

## Executive Summary

| Category | Count | Action Required |
|----------|-------|-----------------|
| **Orphaned Tables** | 2 | Schedule removal |
| **Unused Indexes (0 scans)** | 134 | Review for removal |
| **Redundant Index Candidates** | 33 | Safe to drop |
| **Legacy "dealer" Prefixed Indexes** | ~20 | Rename or drop |
| **Active Tables** | 48 | No action |

**Key Findings:**
1. Two completely orphaned tables: `advertisements` and `market_reports`
2. 134 indexes have never been scanned (stats reliable - DB not restarted in weeks)
3. 33 indexes are redundant due to dealer→merchant rename leaving duplicate indexes
4. No triggers, 2 views (pg_stat_statements), 121 functions (mostly pgvector)

**Stats Reliability:** Database has not been restarted in weeks. Index scan counts of 0 indicate genuinely unused indexes, not stats reset artifacts.

---

## Section 1: Table Classification

### 1.1 Orphaned Tables (No Code References)

| Table | Rows | Size | Evidence | Recommendation | Decision |
|-------|------|------|----------|----------------|----------|
| `advertisements` | 0 | 16 kB | Schema defined, only referenced in index scripts | **DROP** - never used | ✅ APPROVED |
| `market_reports` | 0 | 16 kB | Schema defined, zero code references | **DROP** - never used | ✅ APPROVED |

> **Decision (2026-01-12):** Both tables approved for removal. Originally planned for sponsored ads and market analytics features that were never implemented (v1 placeholders from Aug 2025).

### 1.2 Low Activity but Used Tables

| Table | Rows | SeqScans | IdxScans | Code Refs | Status |
|-------|------|----------|----------|-----------|--------|
| `data_subscriptions` | 0 | 3 | 0 | 1 file | DaaS feature (future) |
| `executions` | 0 | 11 | 0 | 9 files | Harvester monitoring |
| `execution_logs` | 0 | 5 | 0 | 8 files | Harvester debugging |
| `subscriptions` | 0 | 42 | 0 | 5 files | Billing system |
| `brand_alias_applications_daily` | 0 | 35 | 0 | 2 files | Impact tracking |
| `product_reports` | 0 | 137,006 | 0 | 2 files | Data quality (needs index review) |
| `VerificationToken` | 0 | 2 | 0 | NextAuth | Auth system |
| `Session` | 0 | 3 | 0 | NextAuth | Auth system |

### 1.3 High Activity Tables (Top 10)

| Table | Rows | Total Scans | Writes (I/U/D) | Size |
|-------|------|-------------|----------------|------|
| `source_products` | 1,462 | 1,501,080 | 64K/84K/14K | 4 MB |
| `source_product_identifiers` | 42,924 | 391,001 | 367K/69K/324K | 38 MB |
| `source_product_presence` | 1,462 | 340,626 | 64K/148K/14K | 1.6 MB |
| `prices` | 20,000 | 166,082 | 201K/86K/132K | 10 MB |
| `source_product_seen` | 1,462 | 186,422 | 94K/0/14K | 1.5 MB |
| `affiliate_feed_runs` | 386 | 260,002 | 433/520/47 | 344 kB |
| `product_resolve_requests` | 12,519 | 140,830 | 56K/127K/43K | 15 MB |
| `sources` | 12 | 140,575 | 15/2/3 | 48 kB |
| `retailers` | 10 | 145,758 | 47/1/37 | 80 kB |
| `products` | 0 | 64,520 | 4.7K/0/4.7K | 1.3 MB |

---

## Section 2: Index Analysis

### 2.1 Unused Indexes (Top 20 by Size)

| Index | Table | Size | Scans | Action |
|-------|-------|------|-------|--------|
| `source_product_identifiers_pkey` | source_product_identifiers | 13 MB | 0 | **KEEP** - PK required |
| `source_product_identifiers_lookup` | source_product_identifiers | 4.5 MB | 0 | Review - may be unused |
| `product_resolve_requests_createdAt_idx` | product_resolve_requests | 584 kB | 0 | Review for removal |
| `source_product_presence_pkey` | source_product_presence | 576 kB | 0 | **KEEP** - PK required |
| `source_product_seen_pkey` | source_product_seen | 472 kB | 0 | **KEEP** - PK required |
| `product_resolve_requests_sourceId_idx` | product_resolve_requests | 448 kB | 0 | Review for removal |
| `product_links_pkey` | product_links | 320 kB | 0 | **KEEP** - PK required |
| `quarantined_records_pkey` | quarantined_records | 216 kB | 0 | **KEEP** - PK required |
| `click_events_pkey` | click_events | 184 kB | 0 | **KEEP** - PK required |
| `prices_inStock_idx` | prices | 144 kB | 0 | **KEEP** - used in raw SQL JOIN |
| `prices_ingestionRunType_idx` | prices | 144 kB | 0 | **DROP** ✅ - no query filtering |
| `click_events_sessionId_idx` | click_events | 120 kB | 0 | Review for removal |
| `source_products_brandNorm_createdAt_idx` | source_products | 112 kB | 0 | Review for removal |
| `source_products_productId_idx` | source_products | 104 kB | 0 | Review for removal |

### 2.2 Redundant Index Candidates (DROP SAFE) ✅ APPROVED

These indexes have the same leading columns as another covering index:

| Redundant Index | Covered By | Table | Size | Decision |
|-----------------|------------|-------|------|----------|
| `affiliate_feeds_sourceId_idx` | `affiliate_feeds_sourceId_variant_key` | affiliate_feeds | 16 kB | ✅ DROP |
| `alerts_userId_idx` | `alerts_userid_productid_ruletype_key` | alerts | 8 kB | ✅ DROP |
| `alerts_watchlistItemId_idx` | `idx_alerts_watchlist_item` | alerts | 8 kB | ✅ DROP |
| `click_events_clickId_idx` | `click_events_clickId_key` | click_events | 8 kB | ✅ DROP |
| `merchant_contacts_merchantId_idx` | `dealer_contacts_dealerId_email_key` | merchant_contacts | 16 kB | ✅ DROP |
| `merchant_invites_merchantId_idx` | `dealer_invites_dealerId_email_key` | merchant_invites | 8 kB | ✅ DROP |
| `merchant_retailers_merchantId_idx` | `merchant_retailers_merchantId_retailerId_key` | merchant_retailers | 16 kB | ✅ DROP |
| `merchant_user_retailers_merchantUserId_idx` | `merchant_user_retailers_merchantUserId_merchantRetailerId_key` | merchant_user_retailers | 8 kB | ✅ DROP |
| `merchant_users_merchantId_idx` | `merchant_users_merchantId_email_key` | merchant_users | 16 kB | ✅ DROP |
| `product_links_status_idx` | `product_links_status_matchType_idx` | product_links | 56 kB | ✅ DROP |
| `product_resolve_requests_status_idx` | `product_resolve_requests_status_updatedAt_idx` | product_resolve_requests | 664 kB | ✅ DROP |
| `retailer_skus_retailerId_idx` | `retailer_skus_retailerId_retailerSkuHash_key` | retailer_skus | 16 kB | ✅ DROP |
| `source_product_seen_runId_idx` | `source_product_seen_runId_sourceProductId_key` | source_product_seen | 72 kB | ✅ DROP |
| `watchlist_items_userId_idx` | `watchlist_items_sku_active_uniq` | watchlist_items | 16 kB | ✅ DROP |

**Total Redundant Index Space:** ~900 kB

> **Decision (2026-01-12):** All 14 redundant indexes approved for removal. Composite indexes with same leading columns provide equivalent query performance.

### 2.3 Legacy "dealer" Prefixed Indexes

These indexes have stale "dealer" naming from the dealer→merchant migration:

#### Phase 1: DROP (confirmed duplicates) ✅ APPROVED

| Index | Duplicate Of | Table | Decision |
|-------|--------------|-------|----------|
| `dealer_feed_test_runs_feedId_idx` | `retailer_feed_test_runs_feedId_idx` | retailer_feed_test_runs | ✅ DROP |
| `dealer_feed_test_runs_startedAt_idx` | `retailer_feed_test_runs_startedAt_idx` | retailer_feed_test_runs | ✅ DROP |
| `dealer_skus_feedId_idx` | `retailer_skus_feedId_idx` | retailer_skus | ✅ DROP |
| `dealer_users_dealerId_email_key` | `merchant_users_merchantId_email_key` | merchant_users | ✅ DROP |
| `dealer_invites_inviteToken_idx` | `dealer_invites_inviteToken_key` | merchant_invites | ✅ DROP |

> **Decision (2026-01-12):** 5 duplicate indexes approved for removal. retailer_*/merchant_* versions retained.

#### Phase 2: RENAME (cosmetic cleanup, non-urgent)

| Index | Table | Action |
|-------|-------|--------|
| `dealer_contacts_dealerId_email_key` | merchant_contacts | Rename |
| `dealer_contacts_email_idx` | merchant_contacts | Rename |
| `dealer_feed_runs_pkey` | retailer_feed_runs | Rename |
| `dealer_feed_runs_startedAt_idx` | retailer_feed_runs | Rename |
| `dealer_feed_test_runs_pkey` | retailer_feed_test_runs | Rename |
| `dealer_feeds_pkey` | retailer_feeds | Rename |
| `dealer_feeds_enabled_idx` | retailer_feeds | Rename |
| `dealer_invites_dealerId_email_key` | merchant_invites | Rename |
| `dealer_invites_inviteToken_key` | merchant_invites | Rename |
| `dealer_notification_prefs_dealerId_key` | merchant_notification_prefs | Rename |
| `dealer_skus_pkey` | retailer_skus | Rename |
| `dealer_skus_isActive_idx` | retailer_skus | Rename |
| `dealer_users_email_idx` | merchant_users | Rename |
| `dealers_pkey` | merchants | Rename |
| `dealers_pixelApiKey_key` | merchants | Rename |
| `dealers_stripeCustomerId_key` | merchants | Rename |
| `dealers_stripeSubscriptionId_key` | merchants | Rename |

### 2.4 High-Value Indexes (Most Used)

| Index | Table | Scans | Size |
|-------|-------|-------|------|
| `source_products_pkey` | source_products | 1,494,340 | 432 kB |
| `source_product_identifiers_unique` | source_product_identifiers | 379,971 | 8.9 MB |
| `source_product_presence_sourceProductId_key` | source_product_presence | 340,418 | 448 kB |
| `source_product_seen_runId_sourceProductId_key` | source_product_seen | 172,093 | 648 kB |
| `sources_pkey` | sources | 139,812 | 16 kB |
| `prices_pkey` | prices | 137,170 | 1.5 MB |
| `affiliate_feed_runs_pkey` | affiliate_feed_runs | 125,771 | 40 kB |
| `product_resolve_requests_idempotencyKey_key` | product_resolve_requests | 85,875 | 2.6 MB |

---

## Section 3: Column Analysis

### 3.1 Potentially Unused Columns

Based on codebase analysis, these columns may be candidates for deprecation:

| Table | Column | Notes |
|-------|--------|-------|
| `products.isSubsonic` | Has index, 0 scans | Review if feature launched |
| `products.bulletType` | Has index, 0 scans | Review if feature launched |
| `products.pressureRating` | Has index, 0 scans | Review if feature launched |
| `products.purpose` | Has index, 0 scans | Review if feature launched |
| `prices.inStock` | Has index, 0 scans | Review query patterns |
| `prices.ingestionRunType` | Has index, 0 scans | Review query patterns |

### 3.2 Schema-Only Columns (In Schema but Not DB)

These were fixed in recent migrations:
- `retailer_skus.contentHash` - Fixed 2026-01-11
- `products.lastEmbeddedAt` - Fixed 2026-01-11

---

## Section 4: Database Objects Summary

### 4.1 Sequences
| Sequence | Status |
|----------|--------|
| `affiliate_feeds_feedLockId_seq` | Active |

### 4.2 Views
| View | Purpose |
|------|---------|
| `pg_stat_statements` | Query statistics |
| `pg_stat_statements_info` | Statistics metadata |

### 4.3 Triggers
None defined.

### 4.4 Functions
121 functions - all from pgvector extension (vector search operations).

---

## Section 5: Prioritized Cleanup Plan

### Phase 1: Immediate (Safe to Execute Now)

**1. Drop Orphaned Tables**
```sql
-- These tables have zero code references
DROP TABLE IF EXISTS advertisements;
DROP TABLE IF EXISTS market_reports;
```

**2. Drop Redundant Indexes (~900 kB savings)**
```sql
-- Covered by composite/unique indexes
DROP INDEX IF EXISTS affiliate_feeds_sourceId_idx;
DROP INDEX IF EXISTS alerts_userId_idx;
DROP INDEX IF EXISTS alerts_watchlistItemId_idx;
DROP INDEX IF EXISTS click_events_clickId_idx;
DROP INDEX IF EXISTS merchant_contacts_merchantId_idx;
DROP INDEX IF EXISTS merchant_invites_merchantId_idx;
DROP INDEX IF EXISTS merchant_retailers_merchantId_idx;
DROP INDEX IF EXISTS merchant_user_retailers_merchantUserId_idx;
DROP INDEX IF EXISTS merchant_users_merchantId_idx;
DROP INDEX IF EXISTS product_links_status_idx;
DROP INDEX IF EXISTS product_resolve_requests_status_idx;
DROP INDEX IF EXISTS retailer_skus_retailerId_idx;
DROP INDEX IF EXISTS source_product_seen_runId_idx;
DROP INDEX IF EXISTS watchlist_items_userId_idx;

-- Duplicate from dealer->merchant migration
DROP INDEX IF EXISTS dealer_feed_test_runs_feedId_idx;
DROP INDEX IF EXISTS dealer_feed_test_runs_startedAt_idx;
DROP INDEX IF EXISTS dealer_skus_feedId_idx;
DROP INDEX IF EXISTS dealer_users_dealerId_email_key;
DROP INDEX IF EXISTS dealer_invites_inviteToken_idx;
DROP INDEX IF EXISTS idx_alerts_watchlist_item;
```

### Phase 2: After 7-Day Monitoring Window

**1. Review Unused Non-PK Indexes**

Monitor these indexes for usage over 7 days before dropping:
- `source_product_identifiers_lookup` (4.5 MB)
- `product_resolve_requests_createdAt_idx` (584 kB)
- `product_resolve_requests_sourceId_idx` (448 kB)
- `prices_inStock_idx` (144 kB)
- `prices_ingestionRunType_idx` (144 kB)
- `click_events_sessionId_idx` (120 kB)
- `source_products_brandNorm_createdAt_idx` (112 kB)
- `source_products_productId_idx` (104 kB)

**2. Rename Legacy "dealer" Indexes**

Create migration to rename ~20 indexes with dealer prefix.

### Phase 3: Future Consideration

**1. Review Low-Activity Tables**

These tables have code references but zero data - monitor for 30 days:
- `data_subscriptions` - DaaS feature (keep if planned)
- `executions` / `execution_logs` - Harvester monitoring (keep)
- `subscriptions` - Billing (keep)

**2. Investigate product_reports High Scan Count**

137,006 seq scans with 0 rows suggests inefficient query patterns.
- Add composite indexes on common query filters
- Review `apps/api/src/routes/reports.ts` query patterns

---

## Section 6: Monitoring Recommendations

### Enable Query Logging
```sql
-- Enable pg_stat_statements if not already
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- Check most frequent queries
SELECT query, calls, mean_exec_time, rows
FROM pg_stat_statements
ORDER BY calls DESC
LIMIT 20;
```

### Weekly Index Usage Check
```sql
-- Run weekly to catch unused indexes
SELECT schemaname, relname, indexrelname, idx_scan
FROM pg_stat_user_indexes
WHERE idx_scan = 0
ORDER BY pg_relation_size(indexrelid) DESC;
```

### Table Bloat Monitoring
```sql
-- Check for dead tuples indicating need for VACUUM
SELECT relname, n_dead_tup, last_autovacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC;
```

---

## Appendix: Raw Query Outputs

Full audit data available in: `S:\workspace\IronScout\db-audit-report.txt`

---

*Report generated by Claude Code database audit script.*
# Status: Historical Audit (Archived)
This document is historical and non-authoritative.
