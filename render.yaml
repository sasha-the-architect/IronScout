# Render.com Infrastructure as Code
# This file defines all services for the IronScout.ai application
#
# IMPORTANT: Redis must be created manually in Render dashboard
# Redis cannot be defined in Blueprint files - see DEPLOYMENT.md for instructions

# --------------------------------------------------------------------------
# Environment Variable Groups
# --------------------------------------------------------------------------
envVarGroups:
  - name: ironscout-common
    envVars:
      - key: NODE_ENV
        value: production
      - key: NODE_VERSION
        value: 25.5.0
      - key: PNPM_VERSION
        value: 10.28.1

  - name: ironscout-urls
    envVars:
      - key: NEXT_PUBLIC_API_URL
        value: https://api.ironscout.ai
      - key: NEXT_PUBLIC_MERCHANT_URL
        value: https://merchant.ironscout.ai
      - key: NEXT_PUBLIC_WEB_URL
        value: https://ironscout.ai
      - key: ADMIN_PORTAL_URL
        value: https://admin.ironscout.ai
      - key: FRONTEND_URL
        value: https://www.ironscout.ai

  - name: ironscout-email
    envVars:
      - key: EMAIL_FROM
        value: IronScout <noreply@ironscout.ai>

  - name: ironscout-secrets
    envVars:
      - key: NEXTAUTH_SECRET
        sync: false
      - key: RESEND_API_KEY
        sync: false
      - key: ADMIN_EMAILS
        sync: false

  - name: ironscout-redis
    envVars:
      - key: REDIS_HOST
        sync: false
      - key: REDIS_PORT
        sync: false

  - name: ironscout-stripe
    envVars:
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      - key: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        sync: false

  - name: ironscout-google
    envVars:
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false

  - name: ironscout-slack
    envVars:
      - key: SLACK_DATAFEED_ALERTS_WEBHOOK_URL
        sync: false

  - name: ironscout-openai
    envVars:
      - key: OPENAI_API_KEY
        sync: false

databases:
  - name: ironscout-db
    databaseName: ironscout
    user: ironscout
    plan: free
    region: ohio
    ipAllowList: []

services:
  # --------------------------------------------------------------------------
  # API Backend Service
  # --------------------------------------------------------------------------
  - type: web
    name: ironscout-api
    runtime: node
    region: ohio
    plan: free
    buildCommand: pnpm install && pnpm --filter @ironscout/db db:generate && pnpm --filter @ironscout/api type-check
    startCommand: cd apps/api && pnpm start
    healthCheckPath: /health
    envVars:
      - fromGroup: ironscout-common
      - fromGroup: ironscout-urls
      - fromGroup: ironscout-secrets
      - fromGroup: ironscout-redis
      - fromGroup: ironscout-stripe
      - fromGroup: ironscout-slack
      - fromGroup: ironscout-openai
      - key: PORT
        value: 8000
      - key: DATABASE_URL
        fromDatabase:
          name: ironscout-db
          property: connectionString
      - key: FROM_EMAIL
        sync: false

  # --------------------------------------------------------------------------
  # Next.js Web Frontend
  # --------------------------------------------------------------------------
  - type: web
    name: ironscout-web
    runtime: node
    region: ohio
    plan: free
    buildCommand: pnpm install && pnpm --filter @ironscout/web build
    startCommand: cd apps/web && pnpm start
    healthCheckPath: /
    envVars:
      - fromGroup: ironscout-common
      - fromGroup: ironscout-urls
      - fromGroup: ironscout-secrets
      - fromGroup: ironscout-stripe
      - fromGroup: ironscout-google
      - key: NEXTAUTH_URL
        value: https://ironscout.ai
      - key: AUTH_TRUST_HOST
        value: true
      - key: COOKIE_DOMAIN
        value: .ironscout.ai

  # --------------------------------------------------------------------------
  # Merchant Portal (B2B retailer interface)
  # --------------------------------------------------------------------------
  - type: web
    name: ironscout-merchant
    runtime: node
    region: ohio
    plan: free
    buildCommand: pnpm install && pnpm --filter @ironscout/db db:generate && pnpm --filter @ironscout/notifications build && pnpm --filter @ironscout/merchant build
    startCommand: cd apps/merchant && pnpm start
    healthCheckPath: /
    envVars:
      - fromGroup: ironscout-common
      - fromGroup: ironscout-urls
      - fromGroup: ironscout-secrets
      - fromGroup: ironscout-email
      - fromGroup: ironscout-redis
      - key: DATABASE_URL
        fromDatabase:
          name: ironscout-db
          property: connectionString

  # --------------------------------------------------------------------------
  # Admin Portal (internal administration)
  # --------------------------------------------------------------------------
  - type: web
    name: ironscout-admin
    runtime: node
    region: ohio
    plan: free
    buildCommand: pnpm install && pnpm --filter @ironscout/db db:generate && pnpm --filter @ironscout/crypto build && pnpm --filter @ironscout/notifications build && pnpm --filter @ironscout/admin build
    startCommand: cd apps/admin && pnpm start
    healthCheckPath: /
    envVars:
      - fromGroup: ironscout-common
      - fromGroup: ironscout-urls
      - fromGroup: ironscout-secrets
      - key: DATABASE_URL
        fromDatabase:
          name: ironscout-db
          property: connectionString

  # --------------------------------------------------------------------------
  # Marketing Site (static) - www.ironscout.ai
  # --------------------------------------------------------------------------
  - type: web
    name: ironscout-www
    runtime: static
    buildCommand: pnpm install --filter @ironscout/www && pnpm --filter @ironscout/www build
    staticPublishPath: apps/www/out
    envVars:
      - fromGroup: ironscout-common
      - key: SKIP_INSTALL_DEPS
        value: true
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block
    # NOTE: No rewrite rule - Next.js static export generates proper index.html files for each route

# --------------------------------------------------------------------------
# NOTE: Harvester worker commented out - requires paid plan
# --------------------------------------------------------------------------
# - type: worker
#   name: ironscout-harvester
#   runtime: node
#   region: ohio
#   plan: starter  # Workers require paid plan
#   buildCommand: pnpm install && pnpm --filter @ironscout/db db:generate && pnpm --filter @ironscout/notifications build && pnpm --filter @ironscout/harvester build
#   startCommand: cd apps/harvester && pnpm worker
#   envVars:
#     - fromGroup: ironscout-common
#     - fromGroup: ironscout-urls
#     - fromGroup: ironscout-secrets
#     - fromGroup: ironscout-redis
#     - fromGroup: ironscout-slack
#     - key: DATABASE_URL
#       fromDatabase:
#         name: ironscout-db
#         property: connectionString
#     - key: FROM_EMAIL
#       sync: false
