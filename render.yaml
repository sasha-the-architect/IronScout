# Render.com Infrastructure as Code
# This file defines all services for the IronScout.ai application
#
# IMPORTANT: Redis must be created manually in Render dashboard
# Redis cannot be defined in Blueprint files - see DEPLOYMENT.md for instructions

databases:
  - name: ironscout-db
    databaseName: ironscout
    user: ironscout
    plan: free  # Change to 'starter' or 'standard' for production
    region: ohio
    ipAllowList: []  # Empty = allow all Render services

services:
  # API Backend Service
  - type: web
    name: ironscout-api
    runtime: node
    region: ohio
    plan: free  # Change to 'starter' or 'standard' for production
    buildCommand: pnpm install && pnpm --filter @ironscout/db db:generate && pnpm --filter @ironscout/api build
    startCommand: cd apps/api && pnpm start
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 8000
      - key: DATABASE_URL
        fromDatabase:
          name: ironscout-db
          property: connectionString
      - key: REDIS_HOST
        sync: false  # Set manually after creating Redis instance
      - key: REDIS_PORT
        sync: false  # Set manually after creating Redis instance
      - key: FRONTEND_URL
        sync: false  # Set manually: https://www.ironscout.ai
      - key: STRIPE_SECRET_KEY
        sync: false  # Set manually in Render dashboard
      - key: STRIPE_WEBHOOK_SECRET
        sync: false  # Set manually in Render dashboard
      - key: RESEND_API_KEY
        sync: false  # Set manually in Render dashboard
      - key: SLACK_DATAFEED_ALERTS_WEBHOOK_URL
        sync: false  # Set manually in Render dashboard
      - key: FROM_EMAIL
        sync: false  # Set manually in Render dashboard
      - key: OPENAI_API_KEY
        sync: false  # Set manually for embeddings
      - key: JWT_SECRET
        sync: false  # REQUIRED: Must match NEXTAUTH_SECRET from web service for auth to work
      - key: ADMIN_EMAILS
        sync: false  # Set manually: comma-separated admin emails

  # Next.js Web Frontend
  - type: web
    name: ironscout-web
    runtime: node
    region: ohio
    plan: free  # Change to 'starter' or 'standard' for production
    buildCommand: pnpm install && pnpm --filter @ironscout/web build
    startCommand: cd apps/web && pnpm start
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_API_URL
        sync: false  # Set manually: https://api.ironscout.ai
      - key: NEXTAUTH_URL
        sync: false  # Set manually: https://ironscout.ai
      - key: JWT_SECRET
        sync: false  # REQUIRED: Must match JWT_SECRET in API service
      - key: AUTH_TRUST_HOST
        value: true
      - key: COOKIE_DOMAIN
        value: .ironscout.ai  # For cross-subdomain auth
      - key: GOOGLE_CLIENT_ID
        sync: false  # Set manually in Render dashboard
      - key: GOOGLE_CLIENT_SECRET
        sync: false  # Set manually in Render dashboard
      - key: ADMIN_EMAILS
        sync: false  # Set manually: comma-separated admin emails
      - key: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        sync: false  # Set manually in Render dashboard

  # Harvester Background Worker
  - type: worker
    name: ironscout-harvester
    runtime: node
    region: ohio
    plan: starter
    buildCommand: pnpm install && pnpm --filter @ironscout/db db:generate && pnpm --filter @ironscout/notifications build && pnpm --filter @ironscout/harvester build
    startCommand: cd apps/harvester && pnpm worker
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: ironscout-db
          property: connectionString
      - key: REDIS_HOST
        sync: false  # Set manually after creating Redis instance
      - key: REDIS_PORT
        sync: false  # Set manually after creating Redis instance
      - key: RESEND_API_KEY
        sync: false  # Set manually in Render dashboard
      - key: SLACK_DATAFEED_ALERTS_WEBHOOK_URL
        sync: false  # Set manually in Render dashboard
      - key: FROM_EMAIL
        sync: false  # Set manually in Render dashboard
      - key: FRONTEND_URL
        sync: false  # Set manually: https://www.ironscout.ai

  # Merchant Portal (B2B retailer interface)
  - type: web
    name: ironscout-merchant
    runtime: node
    region: ohio
    plan: free  # Change to 'starter' or 'standard' for production
    buildCommand: pnpm install && pnpm --filter @ironscout/db db:generate && pnpm --filter @ironscout/notifications build && pnpm --filter @ironscout/merchant build
    startCommand: cd apps/merchant && pnpm start
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: ironscout-db
          property: connectionString
      - key: REDIS_HOST
        sync: false  # Set manually after creating Redis instance
      - key: REDIS_PORT
        sync: false  # Set manually after creating Redis instance
      - key: JWT_SECRET
        generateValue: true
      - key: NEXT_PUBLIC_API_URL
        sync: false  # Set manually: https://api.ironscout.ai
      - key: NEXT_PUBLIC_MERCHANT_URL
        value: https://merchant.ironscout.ai
      - key: RESEND_API_KEY
        sync: false  # Set manually in Render dashboard
      - key: EMAIL_FROM
        value: IronScout <noreply@ironscout.ai>
      - key: ADMIN_PORTAL_URL
        value: https://admin.ironscout.ai
      - key: ADMIN_EMAILS
        sync: false  # Set manually: comma-separated admin emails

  # Admin Portal (internal administration)
  - type: web
    name: ironscout-admin
    runtime: node
    region: ohio
    plan: free  # Change to 'starter' or 'standard' for production
    buildCommand: pnpm install && pnpm --filter @ironscout/db db:generate && pnpm --filter @ironscout/notifications build && pnpm --filter @ironscout/admin build
    startCommand: cd apps/admin && pnpm start
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: ironscout-db
          property: connectionString
      - key: NEXTAUTH_SECRET
        sync: false  # Must match web app's NEXTAUTH_SECRET
      - key: ADMIN_EMAILS
        sync: false  # Set manually: comma-separated admin emails
      - key: NEXT_PUBLIC_WEB_URL
        value: https://ironscout.ai
      - key: NEXT_PUBLIC_MERCHANT_URL
        value: https://merchant.ironscout.ai
      - key: RESEND_API_KEY
        sync: false  # Set manually in Render dashboard

  # Marketing Site (static) - www.ironscout.ai
  - type: web
    name: ironscout-www
    runtime: static
    buildCommand: pnpm install && pnpm --filter @ironscout/www build
    staticPublishPath: apps/www/out
    envVars:
      - key: NODE_ENV
        value: production
      - key: NODE_VERSION
        value: 25.5.0
      - key: PNPM_VERSION
        value: 10.28.1
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
